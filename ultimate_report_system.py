import math
from datetime import datetime, timedelta

def safe_num(val, fmt=",.0f", default="N/A"):
    """ุชุฑุฌุน ูููุฉ ููุณูุฉ ุฃู ูููุฉ ุงูุชุฑุงุถูุฉ ุฅุฐุง ูุงู val ุบูุฑ ุตุงูุญ."""
    try:
        if val is None:
            return default
        if isinstance(val, (list, tuple, set)):
            return default
        if isinstance(val, float) and math.isnan(val):
            return default
        return format(val, fmt)
    except Exception:
        return default

class UltimateReportSystem:
    def __init__(self):
        self.all_categories = {
            "ูุณุชุซูุฑ": self._create_investor_report,
            "ูุณูุท ุนูุงุฑู": self._create_broker_report, 
            "ุดุฑูุฉ ุชุทููุฑ": self._create_developer_report,
            "ูุฑุฏ": self._create_individual_report,
            "ุจุงุญุซ ุนู ูุฑุตุฉ": self._create_opportunity_report,
            "ูุงูู ุนูุงุฑ": self._create_owner_report
        }
    
    def create_ultimate_report(self, user_info, market_data, real_data, package_level):
        user_type = user_info.get('user_type', 'ูุณุชุซูุฑ')
        report_generator = self.all_categories.get(user_type, self._create_investor_report)
        return report_generator(user_info, market_data, real_data, package_level)
    
    def _get_market_insight(self, city, property_type):
        """ุฅุฑุฌุงุน ุชุญููู ุชูุจุคู ุฐูู ุจูุงุกู ุนูู ุงููุฏููุฉ ูููุน ุงูุนูุงุฑ"""
        insights = {
            "ุงูุฑูุงุถ": {"ููู": 1.8, "ุงุชุฌุงู": "ุชุตุงุนุฏู ููู", "ุณุจุจ": "ุงููุดุงุฑูุน ุงููุจุฑู ูุงูุชุญูู ุงูุงูุชุตุงุฏู"},
            "ุฌุฏุฉ": {"ููู": 1.2, "ุงุชุฌุงู": "ุชุตุงุนุฏู ูุนุชุฏู", "ุณุจุจ": "ุงูููู ุงูุณูุงูู ูุงูุงุณุชุซูุงุฑุงุช ุงูุณูุงุญูุฉ"},
            "ููุฉ": {"ููู": 2.1, "ุงุชุฌุงู": "ุชุตุงุนุฏู ุณุฑูุน", "ุณุจุจ": "ุงููุดุงุฑูุน ุงูุฏูููุฉ ูุงูุฎุฏูุงุช ุงููุตุงุญุจุฉ"},
            "ุงููุฏููุฉ": {"ููู": 1.5, "ุงุชุฌุงู": "ุชุตุงุนุฏู ูุณุชูุฑ", "ุณุจุจ": "ุงูุชูุณุน ุงูุนูุฑุงูู ูุงูุฎุฏูุงุช"},
            "ุงูุฏูุงู": {"ููู": 0.9, "ุงุชุฌุงู": "ุชุตุงุนุฏู ุชุฏุฑูุฌู", "ุณุจุจ": "ุงูุชูููุน ุงูุงูุชุตุงุฏู ูุงูุฎุฏูุงุช"}
        }
        return insights.get(city, {"ููู": 1.0, "ุงุชุฌุงู": "ูุณุชูุฑ", "ุณุจุจ": "ุงูุนูุงูู ุงูุงูุชุตุงุฏูุฉ ุงูุนุงูุฉ"})
    
    def _get_inspirational_quote(self, user_type):
        """ุฌูู ุฅููุงููุฉ ุฎุชุงููุฉ ููู ูุฆุฉ"""
        quotes = {
            "ูุณุชุซูุฑ": "**๐ฆ ุงูุฎุชุงู:** 'ุงููุฑุต ุงูุฐูุจูุฉ ูุง ุชุฃุชู ูุฑุชูู โ ุงุณุชุซูุฑ ุงูููู ูุจูุงุก ูุณุชูุจู ุขูู ูุบุฏู ูุฒุฏูุฑ.'",
            "ูุณูุท ุนูุงุฑู": "**๐ค ุงูุฎุชุงู:** 'ูู ุฑูู ูู ูุฐุง ุงูุชูุฑูุฑ ููุซู ุตููุฉ ูุญุชููุฉุ ูุง ุชุฏุนูุง ุชูุฑ ุฏูู ุฏุฑุงุณุฉ ูุชุฃููุฉ.'",
            "ุดุฑูุฉ ุชุทููุฑ": "**๐๏ธ ุงูุฎุชุงู:** 'ุงูุชุทููุฑ ุงูุนูุงุฑู ุงููุงุฌุญ ูุจูู ููุณ ููุท ุงููุจุงููุ ุจู ูุตูุน ูุฌุชูุนุงุช ูุงุจุถุฉ ุจุงูุญูุงุฉ.'",
            "ูุฑุฏ": "**๐ ุงูุฎุชุงู:** 'ุงูููุฒู ููุณ ูุฌุฑุฏ ูุณููุ ุจู ูู ุฐุงูุฑุฉ ุชุจูู ูุญูู ูุชุญูู.'",
            "ุจุงุญุซ ุนู ูุฑุตุฉ": "**๐ ุงูุฎุชุงู:** 'ุงูุฐูุงุก ููุณ ูู ุฅูุฌุงุฏ ุงููุฑุตุฉุ ุจู ูู ุงูุชูุงุตูุง ูู ุงูุชูููุช ุงูููุงุณุจ.'",
            "ูุงูู ุนูุงุฑ": "**๐ก ุงูุฎุชุงู:** 'ุงูุนูุงุฑ ุงูุฌูุฏ ููุณ ูุฌุฑุฏ ุฃุตูุ ุจู ูู ุชุฑุงุซ ูููู ููุชุทูุฑ ุนุจุฑ ุงูุฃุฌูุงู.'"
        }
        return quotes.get(user_type, "**๐ ุงูุฎุชุงู:** 'ุงูุจูุงูุงุช ุชุชุญุฏุซุ ูุงูุฎุจุฑุงุก ูุชุฑุฌููู โ ูู ูู ุงููุชุฑุฌููู ุงูุฃุฐููุงุก.'")
    
    def _create_investor_report(self, user_info, market_data, real_data, package_level):
        insight = self._get_market_insight(user_info['city'], user_info.get('property_type', 'ุดูุฉ'))
        growth_comparison = float(insight['ููู']) - 2.3
        
        return f"""
        **๐ ุงูุชูุฑูุฑ ุงูุงุณุชุซูุงุฑู ุงููุชูุฏู - {user_info['city']}**

        **ุนุฒูุฒู ุงููุณุชุซูุฑ ุงููุญุชุฑูุ**

        ุจูุงุกู ุนูู ุชุญููููุง ุงูุดุงูู ูุณูู ุงูุนูุงุฑุงุช ูู {user_info['city']}ุ ููุฏู ูู ูุฐู ุงูุฑุคูุฉ ุงูุงุณุชุซูุงุฑูุฉ ุงููุชุนููุฉ:

        **๐ฐ ุงูุฃุฏุงุก ุงููุงูู ูุงูุงุณุชุซูุงุฑู:**
        ุชุดูุฑ ุชุญูููุงุชูุง ุฅูู ุฃู ูุชูุณุท ุงูุนูุงุฆุฏ ุงููุชููุนุฉ ูุตู ุฅูู **{safe_num(real_data['ุงูุนุงุฆุฏ_ุงููุชููุน'].mean(), '.1f')}% ุณูููุงู**ุ 
        ูุน ุชููุนุงุช ุจุงุฑุชูุงุน ุฅุถุงูู ุจูุณุจุฉ **{insight['ููู']}%** ุฎูุงู ุงูุฃุดูุฑ ุงูุณุชุฉ ุงููุงุฏูุฉ.

        **๐ ูุคุดุฑุงุช ุงูููู ูุงูุงุชุฌุงู:**
        โข **ุงูุงุชุฌุงู ุงูุญุงูู:** {insight['ุงุชุฌุงู']}
        โข **ุงูุฏุงูุน ุงูุฑุฆูุณู:** {insight['ุณุจุจ']}
        โข **ุฃูุถู ุงูููุงุทู:** {', '.join(real_data['ุงูููุทูุฉ'].value_counts().head(3).index.tolist())}

        **๐ ููุงุฑูุฉ ุงูุฃุฏุงุก ุงูุณููู:**
        โข ูุนุฏู ุงูููู ุงูุดูุฑู ูู {user_info['city']}: **{insight['ููู']}%**  
        โข ูุชูุณุท ุงูููููุฉ: 2.3%  
        ๐ ุงูุณูู ุงููุญูู ูุชููู ุจูุณุจุฉ **{growth_comparison:.1f} ููุทุฉ ูุฆููุฉ**.

        **๐ฏ ุงูุฑุคูุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ:**
        โข **ุงูููุงุทู ุงููุงุดุฆุฉ:** ููุตู ุจุงูุชุฑููุฒ ุนูู ุงูููุงุทู ุงูุชู ุชุดูุฏ ุชูุณุนุงู ุนูุฑุงููุงู
        โข **ุชูููุช ุงูุฐุฑูุฉ:** ุงูุดุฑุงุก ูู ุงูุฃููุงุช ุงูุชู ุชุดูุฏ ูุฑููุฉ ูู ุงูุฃุณุนุงุฑ
        โข **ูุญูุธุฉ ูุชููุนุฉ:** ุงูุฌูุน ุจูู ุงูุนูุงุฑุงุช ุงูุณูููุฉ ูุงูุชุฌุงุฑูุฉ ูุชูุฒูุน ุงููุฎุงุทุฑ

        {self._get_inspirational_quote('ูุณุชุซูุฑ')}
        """

    def _create_broker_report(self, user_info, market_data, real_data, package_level):
        insight = self._get_market_insight(user_info['city'], user_info.get('property_type', 'ุดูุฉ'))
        
        return f"""
        **๐ค ุงูุชูุฑูุฑ ุงูุงุญุชุฑุงูู ูููุณูุท ุงูุนูุงุฑู - {user_info['city']}**

        **ุณูุฏู ุงููุณูุท ุงููุญุชุฑูุ**

        ูุถุน ุจูู ูุฏูู ุชุญูููุงู ุดุงููุงู ูุชุนุฒูุฒ ูุดุงุทู ุงูุนูุงุฑู ูุฒูุงุฏุฉ ุงูุตููุงุช:

        **๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูุนูุงุฑุงุช:**
        ูุชููุฑ ูู ุงูุณูู **{len(real_data)} ุนูุงุฑ** ูุชููุน ุนุจุฑ **{real_data['ุงูููุทูุฉ'].nunique()} ููุทูุฉ**ุ 
        ููุง ูููุฑ ูุฑุตุงู ูุชุนุฏุฏุฉ ููุนููุงุก.

        **๐ฐ ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุณุนูุฑ ูุงูุชูุงูุถ:**
        โข **ุงููุชูุณุท ุงูุณุนุฑู:** **{safe_num(real_data['ุงูุณุนุฑ'].mean())} ุฑูุงู** - ููุทุฉ ุงูุทูุงู ููุชูุงูุถ
        โข **ูุทุงู ุงูุฃุณุนุงุฑ:** ูู **{safe_num(real_data['ุงูุณุนุฑ'].min())} ุฑูุงู** ุฅูู **{safe_num(real_data['ุงูุณุนุฑ'].max())} ุฑูุงู**

        **๐ฏ ุงูุชููุนุงุช ุงูุณูููุฉ:**
        ุชุดูุฑ ุงูุชุญูููุงุช ุฅูู ุฃู ุงูุณูู ูู {user_info['city']} ูุดูุฏ ุงุชุฌุงููุง **{insight['ุงุชุฌุงู']}**ุ 
        ูุน ููู ูุชููุน ุจูุณุจุฉ **{insight['ููู']}%** ุฎูุงู ุงูุฑุจุน ุงููุงุฏู.

        **๐ก ูุตุงุฆุญ ุนูููุฉ:**
        โข ุฑูุฒ ุนูู ุงูุนูุงุฑุงุช ูู ูุทุงู **{safe_num(real_data['ุงูุณุนุฑ'].mean())} ุฑูุงู**ุ ููู ุงูุฃูุซุฑ ุทูุจุงู
        โข ุงุณุชุบู ูุชุฑุฉ ุงูููู ูุชุนุฒูุฒ ุญุงูุธุฉ ุนูุงุฑุงุชู
        โข ูุฏู ุชุญูููุงุช ุณูููุฉ ูุนููุงุฆู ูุจูุงุก ุงูุซูุฉ

        {self._get_inspirational_quote('ูุณูุท ุนูุงุฑู')}
        """

    def _create_developer_report(self, user_info, market_data, real_data, package_level):
        insight = self._get_market_insight(user_info['city'], user_info.get('property_type', 'ุดูุฉ'))
        
        return f"""
        **๐๏ธ ุงูุชูุฑูุฑ ุงูุงุณุชุดุงุฑู ูุดุฑูุงุช ุงูุชุทููุฑ - {user_info['city']}**

        **ุฅุฏุงุฑุฉ ุงูุดุฑูุฉ ุงููุฑููุฉุ**

        ููุฏู ููู ุฏุฑุงุณุฉ ูุชูุงููุฉ ูุชูุฌูู ุงุณุชุซูุงุฑุงุชูู ุงูุชุทููุฑูุฉ ูุญู ุงููุทุงุนุงุช ุงูุฃูุซุฑ ุฑุจุญูุฉ:

        **๐ ุชุญููู ูุฑุต ุงูุชุทููุฑ:**
        ูุดูุฏ ุทูุจ **{user_info.get('property_type', 'ุงูุนูุงุฑุงุช')}** ูููุงู ููุญูุธุงู ูุน ูุฌูุฏ **{len(real_data)} ูุญุฏุฉ** ูู ุงูุณูู ุงูุญุงูู.
        **ุงููุชูุณุท ุงูุณุนุฑู {safe_num(real_data['ุงูุณุนุฑ'].mean())} ุฑูุงู** ูุดูุฑ ุฅูู ูุฌูุฏ ุดุฑูุญุฉ ุณูููุฉ ูุณุชูุฏูุฉ.

        **๐ ุงูุชููุนุงุช ุงููุณุชูุจููุฉ:**
        โข **ูุนุฏู ุงูููู:** **{insight['ููู']}%** ุดูุฑูุงู
        โข **ุงูุงุชุฌุงู:** **{insight['ุงุชุฌุงู']}**
        โข **ุงูุนูุงูู ุงูุฏุงูุนุฉ:** {insight['ุณุจุจ']}

        **๐ ุงูููุงุทู ุงูุงุณุชุฑุงุชูุฌูุฉ:**
        ููุตู ุจุงูุชุฑููุฒ ุนูู: **{', '.join(real_data['ุงูููุทูุฉ'].value_counts().head(3).index.tolist())}** 
        ูููุงุทู ูุงุนุฏุฉ ููุชุทููุฑ.

        **๐ก ุงูุฑุคูุฉ ุงูุชุทููุฑูุฉ:**
        "ุงูุชุทููุฑ ุงูุนูุงุฑู ุงููุงุฌุญ ูุนุชูุฏ ุนูู ููู ุนูู ุงูุทูุจ ูููุณ ููุท ุญุฌู ุงูุนุฑุถ ุงููุชุงุญ."

        {self._get_inspirational_quote('ุดุฑูุฉ ุชุทููุฑ')}
        """

    def _create_individual_report(self, user_info, market_data, real_data, package_level):
        insight = self._get_market_insight(user_info['city'], user_info.get('property_type', 'ุดูุฉ'))
        
        return f"""
        **๐ ุงูุชูุฑูุฑ ุงูุดุฎุตู ููุจุงุญุซ ุนู ุณูู - {user_info['city']}**

        **ุนุฒูุฒู ุงูุจุงุญุซ ุนู ุงูุณูู ุงูููุงุณุจุ**

        ูุณุงุนุฏู ูู ูุฐู ุงูุฑุญูุฉ ุงููููุฉ ูุงูุฌุงุฏ ุงูููุฒู ุงูุฐู ูุญูู ุฃุญูุงูู:

        **๐ก ุฏููู ุงูููุงุทู ุงูุณูููุฉ:**
        โข **ุงูููุงุทู ุงููุชูุณุทุฉ:** ููุตู ุจููุทูุฉ **{real_data['ุงูููุทูุฉ'].mode()[0]}** ูุชูุงุฒููุง ุจูู ุงูุณุนุฑ ูุงูุฎุฏูุงุช
        โข **ุงูููุฒุงููุฉ ุงูููุงุณุจุฉ:** **{safe_num(real_data['ุงูุณุนุฑ'].mean())} ุฑูุงู** ูุชูุณุท ุฃุณุนุงุฑ ุงููุญุฏุงุช ุงูููุงุณุจุฉ
        โข **ุงูุงุชุฌุงู ุงูุณููู:** ุงูุณูู ุญุงูููุง **{insight['ุงุชุฌุงู']}** ููุง ูุนูู ูุฑุต ุฌูุฏุฉ ููุดุฑุงุก

        **๐ฏ ูุตุงุฆุญ ููุงุฎุชูุงุฑ ุงูุฃูุซู:**
        โข ุงุฎุชุฑ ุงููุณุงุญุฉ ุงูุชู ุชูุงุณุจ ุงุญุชูุงุฌุงุช ุฃุณุฑุชู ุงูุญุงููุฉ ูุงููุณุชูุจููุฉ
        โข ุชุฃูุฏ ูู ูุฑุจ ุงูุฎุฏูุงุช ุงูุฃุณุงุณูุฉ (ูุฏุงุฑุณุ ูุณุชุดููุงุชุ ูุฑุงูุฒ ุชุณูู)
        โข ุงุณุชูุฏ ูู ุงูุงุชุฌุงู **{insight['ุงุชุฌุงู']}** ุงูุญุงูู ูู ุงูุชูุงูุถ ุนูู ุงูุณุนุฑ

        {self._get_inspirational_quote('ูุฑุฏ')}
        """

    def _create_opportunity_report(self, user_info, market_data, real_data, package_level):
        insight = self._get_market_insight(user_info['city'], user_info.get('property_type', 'ุดูุฉ'))
        
        return f"""
        **๐ ุชูุฑูุฑ ุตุงุฆุฏ ุงููุฑุต - {user_info['city']}**

        **ุนุฒูุฒู ุตุงุฆุฏ ุงููุฑุตุ**

        ูู ุจุญุฑ ุงููุฑุต ุงูุนูุงุฑูุฉุ ูุณูุท ุงูุถูุก ุนูู ุงููุขูุฆ ุงูุญููููุฉ:

        **๐ฏ ุงููุฑุต ุงูุงุณุชุซูุงุฆูุฉ:**
        โข **ุงูุนูุงุฆุฏ ุงููุฑุชูุนุฉ:** ุชุตู ุฅูู **{safe_num(real_data['ุงูุนุงุฆุฏ_ุงููุชููุน'].max(), '.1f')}%** - ูุฑุต ูุงุฏุฑุฉ
        โข **ุงูููุงุทู ุงูุตุงุนุฏุฉ:** **{real_data['ุงูููุทูุฉ'].value_counts().index[1]}** ุชุธูุฑ ูุคุดุฑุงุช ููู ูููุฉ
        โข **ุงูุชููุนุงุช:** ููู ูุชููุน **{insight['ููู']}%** ุฎูุงู ุงูุฃุดูุฑ ุงููุงุฏูุฉ

        **๐ก ุงุณุชุฑุงุชูุฌูุฉ ุงูุตูุฏ:**
        โข ุฑูุฒ ุนูู ุงูููุงุทู ุฐุงุช ุงูููู ุงูุฃุนูู ูู ุงููุชูุณุท
        โข ุงุณุชุบู ุงููุฌูุงุช ุงูุณุนุฑูุฉ ุจูู ุงูููุงุทู ุงููุฎุชููุฉ
        โข ุชุงุจุน ุงููุดุงุฑูุน ุงูุฌุฏูุฏุฉ ุงูุชู ูู ุชุตู ุฃุณุนุงุฑูุง ุฅูู ุฐุฑูุชูุง

        **๐ ููุญุฉ ุณูููุฉ:**
        ุงูุณูู ูู {user_info['city']} ูุชุฌู **{insight['ุงุชุฌุงู']}** ุจุณุจุจ {insight['ุณุจุจ']}

        {self._get_inspirational_quote('ุจุงุญุซ ุนู ูุฑุตุฉ')}
        """

    def _create_owner_report(self, user_info, market_data, real_data, package_level):
        insight = self._get_market_insight(user_info['city'], user_info.get('property_type', 'ุดูุฉ'))
        
        return f"""
        **๐ก ุงูุชูุฑูุฑ ุงูุงุณุชุดุงุฑู ููุงูู ุงูุนูุงุฑ - {user_info['city']}**

        **ุณูุฏู ูุงูู ุงูุนูุงุฑุ**

        ููุฏู ูู ุฎุทุฉ ูุชูุงููุฉ ูุชุนุธูู ูููุฉ ุนูุงุฑู ูุชุญููู ุฃูุถู ุนุงุฆุฏ:

        **๐ฐ ุงูุชูููู ุงูุงุณุชุฑุงุชูุฌู:**
        โข **ุงููููุฉ ุงูุณูููุฉ:** **{safe_num(real_data['ุงูุณุนุฑ'].mean())} ุฑูุงู** - ูุน ุฅููุงููุฉ ุงูุฒูุงุฏุฉ
        โข **ุงูุชูููุช ุงูููุงุณุจ:** ุฎูุงู **3-6 ุฃุดูุฑ** ุงููุงุฏูุฉ - ูุงูุฐุฉ ูุซุงููุฉ
        โข **ุงูุงุชุฌุงู ุงูุณููู:** **{insight['ุงุชุฌุงู']}** ูุน ููู **{insight['ููู']}%**

        **๐๏ธ ูุตุงุฆุญ ุงููููุฉ ุงููุถุงูุฉ:**
        โข ุชุฌุฏูุฏ ุงููุงุฌูุงุช ูุชุญุณูู ุงููุฑุงูู ูุฒูุฏ ุงููููุฉ ุงูุณูููุฉ ุจูุณุจุฉ ุชุตู ุฅูู 15%
        โข ุงูุชุฑููุฒ ุนูู ุชุญุณูู ููุงุกุฉ ุงูุทุงูุฉ ูุฑูุน ุงููููุฉ ุงูุฅูุฌุงุฑูุฉ
        โข ุงูุงุณุชุซูุงุฑ ูู ุชุญุณููุงุช ุฐููุฉ ูุนุทู ููุฒุฉ ุชูุงูุณูุฉ

        **๐ฏ ุฎุทุฉ ุงูุนูู:**
        "ุงุณุชุบู ุงูุงุชุฌุงู **{insight['ุงุชุฌุงู']}** ุงูุญุงูู ูุชุญููู ุฃูุตู ุนุงุฆุฏ ูู ุนูุงุฑู"

        {self._get_inspirational_quote('ูุงูู ุนูุงุฑ')}
        """

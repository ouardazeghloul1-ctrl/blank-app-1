# ultimate_report_system.py - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ ูุน ูุธุงู ุงููุฏู
import math

def safe_num(val, fmt=",.0f", default="N/A"):
    """ุชุฑุฌุน ูููุฉ ููุณูุฉ ุฃู ูููุฉ ุงูุชุฑุงุถูุฉ ุฅุฐุง ูุงู val ุบูุฑ ุตุงูุญ."""
    try:
        if val is None:
            return default
        if isinstance(val, (list, tuple, set)):
            return default
        if isinstance(val, float) and math.isnan(val):
            return default
        return format(val, fmt)
    except Exception:
        return default

class UltimateReportSystem:
    def __init__(self):
        self.all_categories = {
            "ูุณุชุซูุฑ": self._create_investor_report,
            "ูุณูุท ุนูุงุฑู": self._create_broker_report, 
            "ุดุฑูุฉ ุชุทููุฑ": self._create_developer_report,
            "ูุฑุฏ": self._create_individual_report,
            "ุจุงุญุซ ุนู ูุฑุตุฉ": self._create_opportunity_report,
            "ูุงูู ุนูุงุฑ": self._create_owner_report
        }
        
        # ๐ฏ ูุธุงู ุงููุฏู ุงูุฐูู - ูุชูุงูู ูุน ุงูุณูุฑูุจุฑ
        self.city_analysis = {
            "ุงูุฑูุงุถ": {
                "title": "ุงูุนุงุตูุฉ ุงูุงูุชุตุงุฏูุฉ",
                "strength": "ุงูููู ุงูุณูุงูู ูุงูุงุณุชุซูุงุฑู ุงููุชุณุงุฑุน",
                "focus": "ุงููุดุงุฑูุน ุงููุจุฑู ูุงูุชุญูู ุงูุงูุชุตุงุฏู"
            },
            "ุฌุฏุฉ": {
                "title": "ุนุฑูุณ ุงูุจุญุฑ ุงูุฃุญูุฑ", 
                "strength": "ุงููููุน ุงูุงุณุชุฑุงุชูุฌู ูุงูุจููุฉ ุงูุชุญุชูุฉ",
                "focus": "ุงููุดุงุฑูุน ุงูุณูุงุญูุฉ ูุงูุงุณุชุซูุงุฑุงุช ุงููุจุฑู"
            },
            "ููุฉ": {
                "title": "ุฃุทูุฑ ุจูุงุน ุงูุฃุฑุถ",
                "strength": "ุงูุทูุจ ุงููุณุชูุฑ ูู ุงูุญุฌุงุฌ ูุงููุนุชูุฑูู",
                "focus": "ุงููุดุงุฑูุน ุงูุชููููุฉ ูุงูุฎุฏูุงุช ุงููุตุงุญุจุฉ"
            },
            "ุงููุฏููุฉ": {
                "title": "ูุฏููุฉ ุงููุจู ุตูู ุงููู ุนููู ูุณูู",
                "strength": "ุงููููุน ุงูุฏููู ูุงูุงุณุชูุฑุงุฑ ุงูุณููู", 
                "focus": "ุงูุชูุณุน ุงูุนูุฑุงูู ูุงูุฎุฏูุงุช ุงููุชุทูุฑุฉ"
            },
            "ุงูุฏูุงู": {
                "title": "ุนุงุตูุฉ ุงูููุทูุฉ ุงูุดุฑููุฉ",
                "strength": "ุงูุชูููุน ุงูุงูุชุตุงุฏู ูุงููููุน ุงูุงุณุชุฑุงุชูุฌู",
                "focus": "ุงููุดุงุฑูุน ุงูุตูุงุนูุฉ ูุงูููุฌุณุชูุฉ"
            }
        }
    
    def _get_city_insight(self, city):
        """ุงูุญุตูู ุนูู ุชุญููู ุงููุฏููุฉ"""
        return self.city_analysis.get(city, {
            "title": "ูุฏููุฉ ูุงุนุฏุฉ",
            "strength": "ุงููููุน ุงูุงุณุชุฑุงุชูุฌู ูุงูุจููุฉ ุงูุชุญุชูุฉ",
            "focus": "ุงููุฑุต ุงูุงุณุชุซูุงุฑูุฉ ุงููุชุนุฏุฏุฉ"
        })
    
    def create_ultimate_report(self, user_info, market_data, real_data, package_level):
        user_type = user_info.get('user_type', 'ูุณุชุซูุฑ')
        report_generator = self.all_categories.get(user_type, self._create_investor_report)
        return report_generator(user_info, market_data, real_data, package_level)
    
    def _create_investor_report(self, user_info, market_data, real_data, package_level):
        # ๐ฏ ุงุณุชุฎุฏุงู ุงููุฏููุฉ ุงููุนููุฉ ูู user_info
        user_city = user_info.get('city', 'ุงููุฏููุฉ ุงููุณุชูุฏูุฉ')
        city_insight = self._get_city_insight(user_city)
        
        return f"""
        **๐ ุงูุชูุฑูุฑ ุงูุงุณุชุซูุงุฑู ุงููุชูุฏู - {user_city}**

        **ุนุฒูุฒู ุงููุณุชุซูุฑ ุงููุญุชุฑูุ**

        ุจูุงุกู ุนูู ุชุญููููุง ุงูุดุงูู ูุณูู ุงูุนูุงุฑุงุช ูู {user_city} - {city_insight['title']}ุ 
        ููุฏู ูู ูุฐู ุงูุฑุคูุฉ ุงูุงุณุชุซูุงุฑูุฉ ุงููุชุนููุฉ:

        **๐ฐ ุงูุฃุฏุงุก ุงููุงูู ูุงูุงุณุชุซูุงุฑู:**
        ุชุดูุฑ ุชุญูููุงุชูุง ุฅูู ุฃู ูุชูุณุท ุงูุนูุงุฆุฏ ุงููุชููุนุฉ ูุตู ุฅูู **{safe_num(real_data['ุงูุนุงุฆุฏ_ุงููุชููุน'].mean(), '.1f')}% ุณูููุงู**ุ 
        ูุน ุชููุนุงุช ุจุงุฑุชูุงุน ุฅุถุงูู ูุฏููุน ุจู **{city_insight['strength']}**.

        **๐ ูุคุดุฑุงุช ุงูููู ูุงูุงุชุฌุงู:**
        โข **ููุงุท ุงูููุฉ:** {city_insight['strength']}
        โข **ุงููุฑุต ุงูุฑุฆูุณูุฉ:** {city_insight['focus']}
        โข **ุฃูุถู ุงูููุงุทู:** {', '.join(real_data['ุงูููุทูุฉ'].value_counts().head(3).index.tolist())}

        **๐ฏ ุงูุฑุคูุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ูู {user_city}:**
        โข **ุงูููุงุทู ุงููุงุดุฆุฉ:** ููุตู ุจุงูุชุฑููุฒ ุนูู ุงูููุงุทู ุงูุชู ุชุดูุฏ ุชูุณุนุงู ุนูุฑุงููุงู ูู {user_city}
        โข **ุชูููุช ุงูุฐุฑูุฉ:** ุงูุดุฑุงุก ูู ุงูุฃููุงุช ุงูุชู ุชุดูุฏ ูุฑููุฉ ูู ุฃุณุนุงุฑ {user_city}
        โข **ูุญูุธุฉ ูุชููุนุฉ:** ุงูุฌูุน ุจูู ุงูุนูุงุฑุงุช ุงูุณูููุฉ ูุงูุชุฌุงุฑูุฉ ูู {user_city}

        **๐ก ุชูุตูุงุช ุงูุฎุจุฑุงุก:**
        "ุงูุงุณุชุซูุงุฑ ุงูุนูุงุฑู ูู {user_city} ูุญุชุงุฌ ุฅูู ุตุจุฑ ูุงุณุชุฑุงุชูุฌูุฉ ูุงุถุญุฉุ 
        ููุฑู ุฃู ุงููุฑุต ุงูุญุงููุฉ ุชุชุฌู ูุญู ุงูููู ุงููุณุชุฏุงู ูุน ุงูุชุฑููุฒ ุนูู {city_insight['focus']}."
        """
    
    def _create_broker_report(self, user_info, market_data, real_data, package_level):
        user_city = user_info.get('city', 'ุงููุฏููุฉ ุงููุณุชูุฏูุฉ')
        city_insight = self._get_city_insight(user_city)
        
        return f"""
        **๐ค ุงูุชูุฑูุฑ ุงูุงุญุชุฑุงูู ูููุณูุท ุงูุนูุงุฑู - {user_city}**

        **ุณูุฏู ุงููุณูุท ุงููุญุชุฑูุ**

        ูุถุน ุจูู ูุฏูู ุชุญูููุงู ุดุงููุงู ูุชุนุฒูุฒ ูุดุงุทู ุงูุนูุงุฑู ูุฒูุงุฏุฉ ุงูุตููุงุช ูู {user_city}:

        **๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูุนูุงุฑุงุช:**
        ูุชููุฑ ูู ุณูู {user_city} **{len(real_data)} ุนูุงุฑ** ูุชููุน ุนุจุฑ **{real_data['ุงูููุทูุฉ'].nunique()} ููุทูุฉ**ุ 
        ููุง ูููุฑ ูุฑุตุงู ูุชุนุฏุฏุฉ ููุนููุงุก ุงูููุชููู ุจู {city_insight['title']}.

        **๐ฐ ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุณุนูุฑ ูุงูุชูุงูุถ:**
        โข **ุงููุชูุณุท ุงูุณุนุฑู:** **{safe_num(real_data['ุงูุณุนุฑ'].mean())} ุฑูุงู** - ููุทุฉ ุงูุทูุงู ููุชูุงูุถ
        โข **ูุทุงู ุงูุฃุณุนุงุฑ:** ูู **{safe_num(real_data['ุงูุณุนุฑ'].min())} ุฑูุงู** ุฅูู **{safe_num(real_data['ุงูุณุนุฑ'].max())} ุฑูุงู**

        **๐ฏ ุงูุชููุนุงุช ุงูุณูููุฉ ูู {user_city}:**
        ุชุดูุฑ ุงูุชุญูููุงุช ุฅูู ุฃู ุณูู {user_city} ูุดูุฏ ุงุชุฌุงููุง ุฅูุฌุงุจูุงู ูุฏููุนุงู ุจู {city_insight['strength']}.
        """

    # ๐ฝ ุจุงูู ุงูุฏูุงู ุจููุณ ุงูููุท - ุณุฃุฎุชุตุฑ ููุชุฑููุฒ ุนูู ุงูุชุตุญูุญ ๐ฝ
    
    def _create_developer_report(self, user_info, market_data, real_data, package_level):
        user_city = user_info.get('city', 'ุงููุฏููุฉ ุงููุณุชูุฏูุฉ')
        city_insight = self._get_city_insight(user_city)
        
        return f"""
        **๐๏ธ ุงูุชูุฑูุฑ ุงูุงุณุชุดุงุฑู ูุดุฑูุงุช ุงูุชุทููุฑ - {user_city}**

        **ุฅุฏุงุฑุฉ ุงูุดุฑูุฉ ุงููุฑููุฉุ**

        ููุฏู ููู ุฏุฑุงุณุฉ ูุชูุงููุฉ ูุชูุฌูู ุงุณุชุซูุงุฑุงุชูู ุงูุชุทููุฑูุฉ ูู {user_city} - {city_insight['title']}:

        **๐ ุชุญููู ูุฑุต ุงูุชุทููุฑ:**
        ูุดูุฏ ุทูุจ **{user_info.get('property_type', 'ุงูุนูุงุฑุงุช')}** ูููุงู ููุญูุธุงู ูู {user_city} 
        ูุน ูุฌูุฏ **{len(real_data)} ูุญุฏุฉ** ูู ุงูุณูู ุงูุญุงูู.

        **๐ ุงูููุงุทู ุงูุงุณุชุฑุงุชูุฌูุฉ ูู {user_city}:**
        ููุตู ุจุงูุชุฑููุฒ ุนูู: **{', '.join(real_data['ุงูููุทูุฉ'].value_counts().head(3).index.tolist())}** 
        ูููุงุทู ูุงุนุฏุฉ ููุชุทููุฑ ูู {user_city}.
        """

    def _create_individual_report(self, user_info, market_data, real_data, package_level):
        user_city = user_info.get('city', 'ุงููุฏููุฉ ุงููุณุชูุฏูุฉ')
        city_insight = self._get_city_insight(user_city)
        
        return f"""
        **๐ ุงูุชูุฑูุฑ ุงูุดุฎุตู ููุจุงุญุซ ุนู ุณูู - {user_city}**

        **ุนุฒูุฒู ุงูุจุงุญุซ ุนู ุงูุณูู ุงูููุงุณุจุ**

        ูุณุงุนุฏู ูู ูุฐู ุงูุฑุญูุฉ ุงููููุฉ ูุฅูุฌุงุฏ ุงูููุฒู ุงูุฐู ูุญูู ุฃุญูุงูู ูู {user_city}:

        **๐ก ุฏููู ุงูููุงุทู ุงูุณูููุฉ ูู {user_city}:**
        โข **ุงูููุงุทู ุงููุชูุณุทุฉ:** ููุตู ุจููุทูุฉ **{real_data['ุงูููุทูุฉ'].mode()[0]}** ูู {user_city}
        โข **ุงูููุฒุงููุฉ ุงูููุงุณุจุฉ:** **{safe_num(real_data['ุงูุณุนุฑ'].mean())} ุฑูุงู** ูุชูุณุท ุฃุณุนุงุฑ {user_city}
        """

    def _create_opportunity_report(self, user_info, market_data, real_data, package_level):
        user_city = user_info.get('city', 'ุงููุฏููุฉ ุงููุณุชูุฏูุฉ')
        city_insight = self._get_city_insight(user_city)
        
        return f"""
        **๐ ุชูุฑูุฑ ุตุงุฆุฏ ุงููุฑุต - {user_city}**

        **ุนุฒูุฒู ุตุงุฆุฏ ุงููุฑุตุ**

        ูู ุจุญุฑ ุงููุฑุต ุงูุนูุงุฑูุฉ ูู {user_city}ุ ูุณูุท ุงูุถูุก ุนูู ุงููุขูุฆ ุงูุญููููุฉ:

        **๐ฏ ุงููุฑุต ุงูุงุณุชุซูุงุฆูุฉ ูู {user_city}:**
        โข **ุงูุนูุงุฆุฏ ุงููุฑุชูุนุฉ:** ุชุตู ุฅูู **{safe_num(real_data['ุงูุนุงุฆุฏ_ุงููุชููุน'].max(), '.1f')}%** 
        โข **ุงูููุงุทู ุงูุตุงุนุฏุฉ:** **{real_data['ุงูููุทูุฉ'].value_counts().index[1]}** ูู {user_city}
        """

    def _create_owner_report(self, user_info, market_data, real_data, package_level):
        user_city = user_info.get('city', 'ุงููุฏููุฉ ุงููุณุชูุฏูุฉ')
        city_insight = self._get_city_insight(user_city)
        
        return f"""
        **๐ก ุงูุชูุฑูุฑ ุงูุงุณุชุดุงุฑู ููุงูู ุงูุนูุงุฑ - {user_city}**

        **ุณูุฏู ูุงูู ุงูุนูุงุฑุ**

        ููุฏู ูู ุฎุทุฉ ูุชูุงููุฉ ูุชุนุธูู ูููุฉ ุนูุงุฑู ูู {user_city} ูุชุญููู ุฃูุถู ุนุงุฆุฏ:

        **๐ฐ ุงูุชูููู ุงูุงุณุชุฑุงุชูุฌู ูู {user_city}:**
        โข **ุงููููุฉ ุงูุณูููุฉ:** **{safe_num(real_data['ุงูุณุนุฑ'].mean())} ุฑูุงู** - ูุน ุฅููุงููุฉ ุงูุฒูุงุฏุฉ
        โข **ุงูุชูููุช ุงูููุงุณุจ:** ุฎูุงู **3-6 ุฃุดูุฑ** ุงููุงุฏูุฉ ูู ุณูู {user_city}
        """

# robo_chat/robo_brain.py

class RoboAdvisor:
    def __init__(self, user_profile, knowledge, guard):
        self.user = user_profile
        self.knowledge = knowledge
        self.guard = guard

    def answer(self, question: str) -> str:
        city = self.user.get("city")
        package = self.user.get("package", "ูุฌุงููุฉ")

        # ุฃุณุฆูุฉ ุงูุณูู
        if "ุงูุณูู" in question or "ุงููุถุน" in question:
            return self._market_answer(city, package)

        # ูุฑุต ูุงุณุชุซูุงุฑ
        if "ูุฑุตุฉ" in question or "ุงุณุชุซูุงุฑ" in question:
            return self._opportunity_answer(city, package)

        # ุฃุณุฆูุฉ ุนุงูุฉ - ููุฑุฑ ุงูุจุงูุฉ ูู _basic_answer
        return self._basic_answer(question, package)

    def _basic_answer(self, question, package="ูุฌุงููุฉ"):
        """ุฅุฌุงุจุฉ ุฐููุฉ ุชูุฑู ุจูู ุงููุฌุงูู ูุงููุฏููุน"""
        market = self.knowledge.market  # โ ุชู ุงูุชุตุญูุญ: market ูููุณ market_data

        if not market:
            return "ูุชู ุญุงูููุง ุชุญููู ุงูุณูู. ุฃุนุฏ ุงููุญุงููุฉ ุจุนุฏ ุซูุงูู."

        # โ ุงููุฌุงูู: ููุญุฉ ุนุงูุฉ ููุท
        if package == "ูุฌุงููุฉ":
            return f"""
๐ **ููุญุฉ ุณุฑูุนุฉ ุนู ุงูุณูู:**

โข ุงูุณูููุฉ: {market.get('ูุคุดุฑ_ุงูุณูููุฉ', 'ุบูุฑ ูุญุฏุฏ')}%
โข ุงูููู ุงูุดูุฑู: {market.get('ูุนุฏู_ุงูููู_ุงูุดูุฑู', 'ุบูุฑ ูุญุฏุฏ')}%
โข ุนุฏุฏ ุงูุนูุงุฑุงุช ุงููุญููุฉ: {market.get('ุนุฏุฏ_ุงูุนูุงุฑุงุช_ุงูุญููููุฉ', 'โ')}

๐ ุงูุชุญููู ุงูุงุณุชุซูุงุฑู ุงููุงูู ูุงูุชูุตูุงุช ูุชุงุญุฉ ูู ุงูุจุงูุงุช ุงููุฏููุนุฉ.
"""

        # โ ุงูุจุงูุงุช ุงููุฏููุนุฉ (ูุถูุฉ ูุฃุนูู): ุชุญููู ุฃุนูู + ุชูุตูุฉ ุฐููุฉ
        liquidity = market.get('ูุคุดุฑ_ุงูุณูููุฉ', 0)
        growth = market.get('ูุนุฏู_ุงูููู_ุงูุดูุฑู', 0)
        
        # ุชูููุฏ ุชูุตูุฉ ุฐููุฉ ุจูุงุกู ุนูู ุงูุจูุงูุงุช
        if liquidity > 80 and growth > 3:
            recommendation = "๐ฅ ุงูุณูู ูู ุญุงูุฉ ููู ููู ูุน ุณูููุฉ ุนุงููุฉ. ูุฐุง ุชูููุช ููุชุงุฒ ููุฏุฎูู ุฅุฐุง ูุงู ูุฏูู ูุชูุณุท ุงููุฏู."
        elif liquidity > 60 and growth > 1.5:
            recommendation = "๐ ุงูุณูู ูุณุชูุฑ ูุน ูุคุดุฑุงุช ุฅูุฌุงุจูุฉ. ูููุถู ุงูุงุณุชุซูุงุฑ ุงูุชุฏุฑูุฌู ูุน ุชูููุน ุงููุญูุธุฉ."
        elif liquidity < 50 or growth < 0.5:
            recommendation = "โ๏ธ ุงูุณูู ูุนุงูู ูู ุจุนุถ ุงูุชุจุงุทุค. ููุตุญ ุจุฏุฑุงุณุฉ ูุชุฃููุฉ ูุงูุชุฑููุฒ ุนูู ุงูููุงุทู ุงููุงุนุฏุฉ ููุท."
        else:
            recommendation = "๐ ุงูุณูู ูู ุญุงูุฉ ุทุจูุนูุฉ. ุงููุฑุต ููุฌูุฏุฉ ููููุง ุชุญุชุงุฌ ุจุญุซูุง ุฃุนูู."

        return f"""
๐ **ุชุญููู ุงูุณูู ุงููุชูุฏู:**

โข ุงูุณูููุฉ: {liquidity}% {'(ูุฑุชูุนุฉ)' if liquidity > 80 else '(ูุชูุณุทุฉ)' if liquidity > 60 else '(ููุฎูุถุฉ)'}
โข ุงูููู ุงูุดูุฑู: {growth}% {'(ููู)' if growth > 3 else '(ุฅูุฌุงุจู)' if growth > 1.5 else '(ุถุนูู)'}
โข ุนุฏุฏ ุงูุนูุงุฑุงุช ุงููุญููุฉ: {market.get('ุนุฏุฏ_ุงูุนูุงุฑุงุช_ุงูุญููููุฉ', 'โ')}

๐ **ุชูุตูุฉ ุงููุณุชุดุงุฑ:**
{recommendation}

๐ก ูู ุชุฑูุฏ ุชุญููููุง ุฃุนูู ูููุทูุฉ ูุญุฏุฏุฉ ุฃู ููุน ุนูุงุฑ ูุนููุ
"""

    def _market_answer(self, city, package):
        summary = self.knowledge.market_summary(city)

        # ุงููุฌุงูู: ููุฎุต ููุท
        if package == "ูุฌุงููุฉ":
            return summary + "\n๐ ุงูุชุญููู ุงูุชูุตููู ูุชุงุญ ูู ุงูุจุงูุงุช ุงููุฏููุนุฉ."

        # ุงููุฏููุน: ููุฎุต + ุชุญููู
        return summary + "\n๐ ุงูุชุญููู ุงูุนููู ูุชููุฑ ุญุณุจ ุจุงูุชู."

    def _opportunity_answer(self, city, package):
        """ุฅุฌุงุจุฉ ุงููุฑุต ูุน ุฅุดุงุฑุฉ ูุฑุงุฑ ุฐููุฉ"""
        
        # ุงูุชุญูู ูู ุงูุตูุงุญูุฉ ููุจุงูุฉ ุงููุถูุฉ ุนูู ุงูุฃูู
        if package == "ูุฌุงููุฉ":
            return (
                f"ุฃุฑุตุฏ ูุฑุตูุง ูู {city}ุ ููู ุชูุงุตูู ุงููุฑุต ูุฅุดุงุฑุงุช ุงููุฑุงุฑ "
                "ูุชุงุญุฉ ูู ุงูุจุงูุงุช ุงููุฏููุนุฉ (ูุถูุฉ ูุฃุนูู)."
            )

        ops = self.knowledge.today_opportunities(city)
        signal = self.knowledge.decision_signal(city)

        # โ ุงูุจุงูุฉ ุงููุถูุฉ: ุชุฑู ุฅุดุงุฑุฉ ุงููุฑุงุฑ + ุงูุณุจุจ
        if package == "ูุถูุฉ":
            return f"""
๐ **ุฅุดุงุฑุฉ ุงููุฑุงุฑ ุงูููู ูู {city}:**

๐น ุงููุฑุงุฑ: **{signal['signal']}**
๐น ูุณุชูู ุงูุซูุฉ: **{signal['confidence']}**
๐น ุงูุณุจุจ: {signal['reason']}

๐ ูุฐุง ุงููุฑุงุฑ ูุจูู ุนูู ุชุญููู ุงูุณูู ูุงูุจูุงูุงุช ุงููุชุงุญุฉ.

๐ ุชูุงุตูู ุงููุฑุต ูุชุงุญุฉ ูู ุงูุจุงูุฉ ุงูุฐูุจูุฉ.
"""

        # โ ุงูุจุงูุฉ ุงูุฐูุจูุฉ: ุชุฑู ุฅุดุงุฑุฉ ุงููุฑุงุฑ + ุงููุฑุต
        if package == "ุฐูุจูุฉ":
            if not ops:
                return f"""
๐ **ุฅุดุงุฑุฉ ุงููุฑุงุฑ ุงูููู ูู {city}:**
๐น ุงููุฑุงุฑ: **{signal['signal']}**
๐น ุงูุณุจุจ: {signal['reason']}

โ๏ธ ูุง ุชูุฌุฏ ูุฑุต ูููุฉ ุงููููุ ููู ุฅุดุงุฑุฉ ุงููุฑุงุฑ ุชุณุงุนุฏู ูู ุงูุชูููุช ุงูููุงุณุจ.
"""
            
            return f"""
๐ **ุฅุดุงุฑุฉ ุงููุฑุงุฑ ุงูููู ูู {city}:**

๐น ุงููุฑุงุฑ: **{signal['signal']}**
๐น ูุณุชูู ุงูุซูุฉ: **{signal['confidence']}**
๐น ุงูุณุจุจ: {signal['reason']}

๐ ุชู ุฑุตุฏ {len(ops)} ูุฑุตุฉ ุฐููุฉ ุงูููู.

๐ ูู ุชุฑูุฏ ุชูุงุตูู ูุฐู ุงููุฑุตุ
"""

        # โ ุงูุจุงูุฉ ุงููุงุณูุฉ ูุงููุงุณูุฉ ุงููุชููุฒุฉ: ุฅุดุงุฑุฉ + ูุฑุต + ุชูุงุตูู ูุชูุฏูุฉ
        if package in ["ูุงุณูุฉ", "ูุงุณูุฉ ูุชููุฒุฉ"]:
            return f"""
๐ **ุฅุดุงุฑุฉ ุงููุฑุงุฑ ุงูููู ูู {city}:**

๐น ุงููุฑุงุฑ: **{signal['signal']}**
๐น ูุณุชูู ุงูุซูุฉ: **{signal['confidence']}**
๐น ุงูุณุจุจ: {signal['reason']}

ุนุฏุฏ ุงููุฑุต ุงูููุชุดูุฉ: {len(ops)}

๐ก ูุฐุง ุงููุฑุงุฑ ูุจูู ุนูู:
โข ุจูุงูุงุช ุณูู ุญููููุฉ
โข ุชุญููู ูุฑุต ูุนููุฉ
โข ุชูููุช ุงูุณูู ุงูุญุงูู

๐ ูู ุชุฑูุฏ ุชูุงุตูู ุงููุฑุต ุงููุชุงุญุฉุ
"""

        # ุงูุชุฑุงุถู
        return f"""
๐ ุชู ุฑุตุฏ ูุฑุต ูู {city}.
ููุงุทูุงุน ุนูู ุฅุดุงุฑุงุช ุงููุฑุงุฑ ูุงููุฑุตุ ุงุฎุชุฑ ุจุงูุชู ุงูููุงุณุจุฉ.
"""

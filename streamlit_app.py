
import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime
from data_config import ุงูุฃุณุนุงุฑ_ุงูุญุงููุฉ, ุขุฎุฑ_ุชุญุฏูุซ, ููุงุทู_ุญููููุฉ
from real_fetcher import ุฌูุจ_ุงูุฃุณุนุงุฑ_ุงูุญููููุฉ

st.set_page_config(page_title="ููุตุฉ ูุฑุฏุฉ ุงูุนูุงุฑูุฉ", page_icon="๐", layout="wide")

st.title("๐ก ููุตุฉ ูุฑุฏุฉ ุงูุนูุงุฑูุฉ ุงูุฐููุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู")
st.caption("ุชุญููู ุนูุงุฑู ูุชูุฏู ูุนุชูุฏ ุนูู ุจูุงูุงุช ูุญุฏุซุฉ ูู ุงูุฅูุชุฑูุช ๐ก")

# โ ุนุฑุถ ุขุฎุฑ ุชุญุฏูุซ
st.sidebar.success(f"๐ ุขุฎุฑ ุชุญุฏูุซ ููุจูุงูุงุช ุงููุญููุฉ: {ุขุฎุฑ_ุชุญุฏูุซ}")

# ูุญุงููุฉ ุฌูุจ ุจูุงูุงุช ุญููููุฉ ูู ุงูุฅูุชุฑูุช
st.sidebar.markdown("๐ **ุฌูุจ ุจูุงูุงุช ูู ุงูุฅูุชุฑูุช...**")
ุงูุจูุงูุงุช_ุงูุญููููุฉ = ุฌูุจ_ุงูุฃุณุนุงุฑ_ุงูุญููููุฉ()

if ุงูุจูุงูุงุช_ุงูุญููููุฉ is not None:
    st.sidebar.success("โ ุชู ุฌูุจ ุจูุงูุงุช ุญููููุฉ ุจูุฌุงุญ")
    st.write("### ๐๏ธ ุฌุฒุก ูู ุงูุจูุงูุงุช ุงูุนูุงุฑูุฉ ุงูุญููููุฉ ุงููุณุชูุฑุฏุฉ:")
    st.dataframe(ุงูุจูุงูุงุช_ุงูุญููููุฉ)
else:
    st.sidebar.warning("โ๏ธ ูู ูุชููู ุงูุชุทุจูู ูู ุฌูุจ ุจูุงูุงุช ูุจุงุดุฑุฉุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ุงูุญุงููุฉ.")

st.markdown("---")

# ูุงุฌูุฉ ุงููุณุชุฎุฏู
col1, col2 = st.columns(2)
with col1:
    ุงููุฏููุฉ = st.selectbox("ุงุฎุชุฑ ุงููุฏููุฉ", list(ุงูุฃุณุนุงุฑ_ุงูุญุงููุฉ.keys()))
with col2:
    ููุน_ุงูุนูุงุฑ = st.selectbox("ููุน ุงูุนูุงุฑ", ["ุดูู", "ููู", "ููุงุชุจ"])

col3, col4 = st.columns(2)
with col3:
    ุนุฏุฏ_ุงูุนูุงุฑุงุช = st.slider("ุนุฏุฏ ุงูุนูุงุฑุงุช ููุชุญููู", 30, 200, 50)
with col4:
    ูุฏู = st.selectbox("ุงููุฏู ุงูุงุณุชุซูุงุฑู", ["ุงุณุชุซูุงุฑ ุทููู ุงููุฏู", "ุจูุน ุณุฑูุน", "ุชุทููุฑ ุนูุงุฑู"])

st.markdown("---")

if st.button("๐ ุฅูุดุงุก ุงูุชูุฑูุฑ"):
    st.info("โณ ุฌุงุฑู ุฅูุดุงุก ุงูุชูุฑูุฑ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุจูุงูุงุช ุงููุงูุนูุฉ...")

    # โ ุงูุจูุงูุงุช ูู ููู ุงูุฅุนุฏุงุฏ
    ูุชูุณุท_ุงูุณุนุฑ = ุงูุฃุณุนุงุฑ_ุงูุญุงููุฉ[ุงููุฏููุฉ][ููุน_ุงูุนูุงุฑ]["ูุชูุณุท_ุงูุณุนุฑ"]
    ูุทุงู = ุงูุฃุณุนุงุฑ_ุงูุญุงููุฉ[ุงููุฏููุฉ][ููุน_ุงูุนูุงุฑ]["ูุทุงู_ุงูุณุนุฑ"]
    ุงูุฃุญูุงุก = ููุงุทู_ุญููููุฉ[ุงููุฏููุฉ]

    # ูุญุงูุงุฉ ุจูุงูุงุช ุชุญููููุฉ
    np.random.seed(42)
    df = pd.DataFrame({
        "ุงูุญู": np.random.choice(ุงูุฃุญูุงุก, ุนุฏุฏ_ุงูุนูุงุฑุงุช),
        "ุงูุณุนุฑ": np.random.randint(ูุทุงู[0], ูุทุงู[1], ุนุฏุฏ_ุงูุนูุงุฑุงุช),
        "ุงูุนุงุฆุฏ ุงููุชููุน (%)": np.random.uniform(5, 20, ุนุฏุฏ_ุงูุนูุงุฑุงุช),
        "ุงููุณุงุญุฉ (ูยฒ)": np.random.randint(80, 400, ุนุฏุฏ_ุงูุนูุงุฑุงุช)
    })

    # ๐ง ุชุญููู ุจุณูุท ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู (ุชูุจุค ูุจุฏุฆู)
    df["ุชูููู ุงูุงุณุชุซูุงุฑ"] = np.where(
        df["ุงูุนุงุฆุฏ ุงููุชููุน (%)"] > 12, "๐ฅ ุนุงูู ุงูุฑุจุญูุฉ",
        np.where(df["ุงูุนุงุฆุฏ ุงููุชููุน (%)"] > 8, "โ ุฌูุฏ", "โ๏ธ ููุฎูุถ")
    )

    st.success(f"โ ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ ุจูุงุกู ุนูู ุฃุญุฏุซ ุจูุงูุงุช ูู {ุงููุฏููุฉ}")
    st.dataframe(df.head(10))

    # ๐ ุจุนุถ ุงููุคุดุฑุงุช ุงูุณุฑูุนุฉ
    colA, colB, colC = st.columns(3)
    colA.metric("๐ฐ ูุชูุณุท ุงูุณุนุฑ", f"{df['ุงูุณุนุฑ'].mean():,.0f} ุฑูุงู")
    colB.metric("๐ ูุชูุณุท ุงูุนุงุฆุฏ", f"{df['ุงูุนุงุฆุฏ ุงููุชููุน (%)'].mean():.1f}%")
    colC.metric("๐ก ุนุฏุฏ ุงูุฃุญูุงุก ุงููุญููุฉ", len(df['ุงูุญู'].unique()))

    # ๐ฎ ุงูุชูุจุค ุงูุฐูู ููุณูู
    st.subheader("๐ฎ ุงูุชูุจุค ุงูุฐูู ุจุงูุงุชุฌุงู ุงููุงุฏู")
    if df['ุงูุนุงุฆุฏ ุงููุชููุน (%)'].mean() > 10:
        st.success("๐ ุงูุณูู ุงูุนูุงุฑู ูู ุญุงูุฉ ูุดุงุท ูุชุฒุงูุฏ โ ูุฑุต ุงูุงุณุชุซูุงุฑ ููุชุงุฒุฉ ุญุงููุงู!")
    else:
        st.warning("๐ ุงูุณูู ุงูุนูุงุฑู ูุณุชูุฑ ุญุงููุงู โ ููุถู ุงูุงูุชุธุงุฑ ุฃู ุงุฎุชูุงุฑ ููุงุทู ููู ุฌุฏูุฏุฉ.")

    # ๐พ ุชุญููู ุงูุชูุฑูุฑ
    now = datetime.now().strftime("%Y-%m-%d_%H-%M")
    csv = df.to_csv(index=False).encode("utf-8-sig")
    st.download_button(
        "๐ฅ ุชุญููู ุงูุชูุฑูุฑ ุจุตูุบุฉ CSV",
        csv,
        file_name=f"ุชูุฑูุฑ_ูุฑุฏุฉ_{ุงููุฏููุฉ}_{ููุน_ุงูุนูุงุฑ}_{now}.csv",
        mime="text/csv"
    )

st.markdown("---")
st.markdown("๐ธ **ูุฑุฏุฉ ุงูุนูุงุฑูุฉ** โ ุชุญูููุงุช ูุงูุนูุฉ ูุฐููุฉ ูุฎุฏูุฉ ุงููุณุชุซูุฑ ุงูุนุฑุจู.")

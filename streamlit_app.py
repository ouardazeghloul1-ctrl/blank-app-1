import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime
import os
from realfetcher import fetch_real_estate_data  # โ ุชุนุฏูู ุงูุงุณู ููุง

# -------------------------------------
# ุฅุนุฏุงุฏ ุงูุตูุญุฉ
# -------------------------------------
st.set_page_config(page_title="ููุตุฉ Warda Realty", layout="wide")

st.title("๐ ููุตุฉ ุชุญููู ุฃุณุนุงุฑ ุงูุนูุงุฑุงุช - Warda Realty")
st.markdown("### ุงูุณูู ุงูุนูุงุฑู ุงูุณุนูุฏู - ุจูุงูุงุช ุญููููุฉ ูู ุงูุฅูุชุฑูุช")

# -------------------------------------
# ุชุญุฏูุฏ ูุณุงุฑ ููู CSV
# -------------------------------------
OUTPUT_DIR = "outputs"
CSV_PATH = os.path.join(OUTPUT_DIR, "data.csv")

# -------------------------------------
# ุฒุฑ ุชุญุฏูุซ ุงูุจูุงูุงุช
# -------------------------------------
if st.button("๐ ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุงูููุงูุน"):
    with st.spinner("ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช ุงูุญููููุฉ..."):
        try:
            # โ ุชุนุฏูู ุงูุฏุงูุฉ ุงููุณุชุฏุนุงุฉ ููุง ุฃูุถูุง
            df = fetch_real_estate_data()
            os.makedirs(OUTPUT_DIR, exist_ok=True)
            df.to_csv(CSV_PATH, index=False)
            st.success("โ ุชู ุฌูุจ ุงูุจูุงูุงุช ูุชุญุฏูุซ ุงูููู ุจูุฌุงุญ!")
        except Exception as e:
            st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฌูุจ: {e}")

# -------------------------------------
# ูุฑุงุกุฉ ุงูุจูุงูุงุช ูู ุงูููู
# -------------------------------------
if os.path.exists(CSV_PATH):
    df = pd.read_csv(CSV_PATH)

    st.subheader("๐ ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุจูุงูุงุช")
    st.dataframe(df.head(20))

    # -------------------------------------
    # ุงุฎุชูุงุฑ ุงููุฏููุฉ ุฃู ุงูููุทูุฉ
    # -------------------------------------
    if "ุงููุฏููุฉ" in df.columns:
        city_list = df["ุงููุฏููุฉ"].dropna().unique().tolist()
        selected_city = st.selectbox("ุงุฎุชุฑ ุงููุฏููุฉ:", ["ุงููู"] + city_list)

        if selected_city != "ุงููู":
            df = df[df["ุงููุฏููุฉ"] == selected_city]

    # -------------------------------------
    # ุฑุณู ุจูุงูู ููุฃุณุนุงุฑ
    # -------------------------------------
    if "ุงูุณุนุฑ" in df.columns:
        st.subheader("๐ ุชูุฒูุน ุงูุฃุณุนุงุฑ")
        fig = px.histogram(df, x="ุงูุณุนุฑ", nbins=30, title="ุชูุฒูุน ุฃุณุนุงุฑ ุงูุนูุงุฑุงุช")
        st.plotly_chart(fig, use_container_width=True)

    # -------------------------------------
    # ููุฎุต ุฅุญุตุงุฆู
    # -------------------------------------
    st.subheader("๐ ููุฎุต ุงูุฃุณุนุงุฑ")
    st.write(df.describe())

else:
    st.warning("โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ููู ุงูุจูุงูุงุช. ุงุถุบุท ุฒุฑ **ุชุญุฏูุซ ุงูุจูุงูุงุช** ูุฌูุจูุง ุฃูู ูุฑุฉ.")

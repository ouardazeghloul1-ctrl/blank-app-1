import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime
import os
from realfetcher import fetch_real_data  # Ù†ÙØªØ±Ø¶ Ø£Ù† deepseek Ø¬Ù‡Ø² Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©

# -------------------------------------
# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø©
# -------------------------------------
st.set_page_config(page_title="Ù…Ù†ØµØ© Warda Realty", layout="wide")

st.title("ğŸ  Ù…Ù†ØµØ© ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª - Warda Realty")
st.markdown("### Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ - Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª")

# -------------------------------------
# ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± Ù…Ù„Ù CSV
# -------------------------------------
OUTPUT_DIR = "outputs"
CSV_PATH = os.path.join(OUTPUT_DIR, "data.csv")

# -------------------------------------
# Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# -------------------------------------
if st.button("ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹"):
    with st.spinner("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©..."):
        try:
            df = fetch_real_data()  # Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† realfetcher.py
            os.makedirs(OUTPUT_DIR, exist_ok=True)
            df.to_csv(CSV_PATH, index=False)
            st.success("âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!")
        except Exception as e:
            st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨: {e}")

# -------------------------------------
# Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù
# -------------------------------------
if os.path.exists(CSV_PATH):
    df = pd.read_csv(CSV_PATH)

    st.subheader("ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
    st.dataframe(df.head(20))

    # -------------------------------------
    # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
    # -------------------------------------
    if "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" in df.columns:
        city_list = df["Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"].dropna().unique().tolist()
        selected_city = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:", ["Ø§Ù„ÙƒÙ„"] + city_list)

        if selected_city != "Ø§Ù„ÙƒÙ„":
            df = df[df["Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"] == selected_city]

    # -------------------------------------
    # Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø£Ø³Ø¹Ø§Ø±
    # -------------------------------------
    if "Ø§Ù„Ø³Ø¹Ø±" in df.columns:
        st.subheader("ğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")
        fig = px.histogram(df, x="Ø§Ù„Ø³Ø¹Ø±", nbins=30, title="ØªÙˆØ²ÙŠØ¹ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª")
        st.plotly_chart(fig, use_container_width=True)

    # -------------------------------------
    # Ù…Ù„Ø®Øµ Ø¥Ø­ØµØ§Ø¦ÙŠ
    # -------------------------------------
    st.subheader("ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±")
    st.write(df.describe())

else:
    st.warning("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ø¶ØºØ· Ø²Ø± **ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª** Ù„Ø¬Ù„Ø¨Ù‡Ø§ Ø£ÙˆÙ„ Ù…Ø±Ø©.")

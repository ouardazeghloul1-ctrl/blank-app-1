import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime
import warnings
from io import BytesIO
warnings.filterwarnings('ignore')

# 🎨 تحسين الألوان والتصميم البصري
st.markdown("""
    <style>
        .stApp {
            background-color: #f9fafc;
        }
        h1, h2, h3, h4, h5 {
            color: #003366;
        }
        .css-1v3fvcr {
            background-color: #e6f2ff;
        }
        .stButton>button {
            background-color: #0066cc;
            color: white;
            border-radius: 8px;
            padding: 10px 24px;
            font-weight: bold;
        }
        .stDownloadButton>button {
            background-color: #00a86b;
            color: white;
            border-radius: 6px;
        }
    </style>
""", unsafe_allow_html=True)

# إعدادات العربية
plt.rcParams['font.family'] = 'DejaVu Sans'
plt.rcParams['axes.unicode_minus'] = False

st.set_page_config(page_title="وردة العقارية", page_icon="🏠", layout="wide")

# العنوان الرئيسي المحسن
st.title("🏡 منصة وردة للتحليل العقاري الذكي بالذكاء الاصطناعي")
st.caption("حلول تحليل عقاري متقدمة لتحديد أفضل الفرص الاستثمارية بدقة عالية 💼")
st.markdown("---")

# نموذج إدخال البيانات الأساسية
col1, col2 = st.columns(2)
with col1:
    المدينة = st.selectbox("🏙️ اختر المدينة", ["الرياض", "جدة", "الدمام", "مكة", "المدينة"])
with col2:
    اسم_العميل = st.text_input("👤 اسم العميل", placeholder="أدخل اسم العميل")

col3, col4 = st.columns(2)
with col3:
    نوع_العقار = st.selectbox("🏠 نوع العقار", ["شقق", "فلل", "مكاتب", "محلات"])
with col4:
    عدد_العقارات = st.slider("📊 عدد العقارات", 50, 500, 100)

# 🎯 القسم الجديد - تخصيص التقرير
st.markdown("---")
st.subheader("🎯 تخصيص التقرير المتقدم")

col5, col6 = st.columns(2)
with col5:
    الهدف_الاستثماري = st.selectbox(
        "الهدف الاستثماري:",
        [
            "🏠 استثمار طويل المدى (5+ سنوات)",
            "⚡ تداول عقاري سريع (6-12 شهر)", 
            "📈 تطوير مشروع استثماري",
            "🛡️ تنويع المحفظة الاستثمارية",
            "🎯 أعلى عائد على المدى القصير"
        ]
    )
    
with col6:
    الميزانية = st.selectbox(
        "الميزانية المتوقعة:",
        [
            "💰 حتى 500,000 ريال",
            "💵 500,000 - 1,000,000 ريال", 
            "💎 1,000,000 - 2,000,000 ريال",
            "🏦 2,000,000 - 5,000,000 ريال",
            "👑 أكثر من 5,000,000 ريال"
        ]
    )

مستوى_التفصيل = st.radio(
    "📊 مستوى التفصيل المطلوب:",
    ["📋 تقرير سريع (تحليل أساسي)", "📊 تقرير متقدم (تحليل مفصل)", "📚 دراسة شاملة (توصيات استراتيجية)"]
)

# زر التشغيل
if st.button("🚀 أنشئ التقرير المتخصص", type="primary"):
    with st.spinner("جاري إنشاء التقرير المتخصص..."):
        # محاكاة إنشاء البيانات المتخصصة
        data = {
            'العقار': [f'عقار {i+1}' for i in range(عدد_العقارات)],
            'السعر': np.random.randint(300000, 2000000, عدد_العقارات),
            'المساحة': np.random.randint(80, 400, عدد_العقارات),
            'الحي': np.random.choice(['النخيل', 'الروضة', 'الصفا', 'الزهراء', 'الربوة'], عدد_العقارات),
            'العائد_المتوقع_٪': np.random.uniform(5, 25, عدد_العقارات),
            'مستوى_الخطورة': np.random.choice(['منخفض', 'متوسط', 'مرتفع'], عدد_العقارات)
        }
        
        df = pd.DataFrame(data)
        
        # 🎨 تأثير مستوى التفصيل على كمية البيانات
        if "سريع" in مستوى_التفصيل:
            df = df.sample(30)
            st.info("🔍 وضع التقرير السريع: تحليل 30 عقاراً مختاراً بعناية")
        elif "متقدم" in مستوى_التفصيل:  # ✅ تم تصحيح الخطأ هنا
            df = df.sample(80)
            st.info("📊 وضع التقرير المتقدم: تحليل 80 عقاراً بتفاصيل شاملة")
        else:
            st.info("📚 وضع الدراسة الشاملة: تحليل كامل لجميع العقارات المتاحة")
        
        # 💬 فقرة "نبذة عن التقرير"
        st.markdown(f"""
        #### 🧭 هذا التقرير أُنشئ خصيصًا لـ **{اسم_العميل if اسم_العميل else 'عميلنا الكريم'}**
        **الهدف الاستثماري:** {الهدف_الاستثماري}  
        **الميزانية المتوقعة:** {الميزانية}  
        **نوع العقار:** {نوع_العقار}  
        **المدينة:** {المدينة}
        """)
        
        # عرض النتائج المتخصصة
        st.success(f"✅ تم إنشاء التقرير المتخصص للهدف: {الهدف_الاستثماري}")
        
        # الإحصائيات المتقدمة
        st.subheader("📈 النتائج المتخصصة")
        
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("💰 متوسط السعر", f"{df['السعر'].mean():,.0f} ريال")
        with col2:
            st.metric("📐 متوسط المساحة", f"{df['المساحة'].mean():.0f} م²")
        with col3:
            st.metric("📊 متوسط العائد", f"{df['العائد_المتوقع_٪'].mean():.1f}%")
        with col4:
            عقارات_منخفضة_خطورة = len(df[df['مستوى_الخطورة'] == 'منخفض'])
            st.metric("🛡️ عقارات آمنة", f"{عقارات_منخفضة_خطورة} عقار")
        
        # ✨ الملخص النصي الطبيعي
        متوسط_السعر = df['السعر'].mean()
        متوسط_العائد = df['العائد_المتوقع_٪'].mean()
        
        st.markdown(f"""
        ### 📄 خلاصة التقرير:
        - متوسط سعر العقار في **{المدينة}** هو حوالي **{متوسط_السعر:,.0f} ريال**.
        - متوسط العائد المتوقع هو **{متوسط_العائد:.1f}%**.
        - بناءً على هدفك **({الهدف_الاستثماري})** نوصي بالتركيز على الأحياء ذات الخطورة المنخفضة لتحقيق توازن بين العائد والأمان.
        - تم تحليل **{len(df)} عقار** في **{المدينة}** لتقديم أفضل التوصيات.
        """)
        
        # التوصيات الاستثمارية حسب الهدف
        st.subheader("💡 التوصيات الاستراتيجية")
        
        if "طويل المدى" in الهدف_الاستثماري:
            st.info("""
            **🎯 توصيات الاستثمار طويل المدى:**
            • ركز على العقارات في الأحياء الراقية (النخيل، الصفا)
            • اختر عقارات بمساحات كبيرة (+200م²) لتحقيق استقرار طويل
            • استثمر في مناطق ذات خطط تطوير مستقبلية
            • العائد المتوقع: 8-15% سنوياً على المدى الطويل
            """)
        elif "سريع" in الهدف_الاستثماري:
            st.info("""
            **⚡ توصيات التداول السريع:**
            • ابحث عن عقارات تحت السعر السوقي بنسبة 10-15%
            • ركز على المناطق ذات الطلب المتزايد (الروضة، الزهراء)
            • اختر عقارات سهلة البيع (شقق، محلات تجارية)
            • استهدف عائد سريع 15-25% خلال 6-12 شهر
            """)
        elif "تطوير" in الهدف_الاستثماري:
            st.info("""
            **🏗️ توصيات التطوير الاستثماري:**
            • اختر أراضي أو عقارات قابلة للتطوير
            • ركز على المناطق ذات البنية التحتية المتطورة
            • احسب تكاليف التطوير بدقة قبل الاستثمار
            • العائد المتوقع: 25-40% لمشاريع التطوير
            """)
        else:
            st.info("""
            **🛡️ توصيات عامة للاستثمار الآمن:**
            • نوّع استثماراتك بين عدة أحياء
            • حافظ على توازن بين العائد ومستوى الخطورة
            • استشر خبيراً قبل اتخاذ القرارات الكبيرة
            """)
        
        # 📊 الرسوم البيانية المتقدمة
        st.subheader("📊 التحليل البصري المتقدم")
        
        # الرسم البياني 1: العلاقة بين المساحة والسعر
        fig, ax = plt.subplots(figsize=(12, 6))
        sns.scatterplot(data=df, x='المساحة', y='السعر', hue='مستوى_الخطورة', 
                       palette={'منخفض': 'green', 'متوسط': 'orange', 'مرتفع': 'red'}, 
                       alpha=0.7, s=100)
        plt.title(f'العلاقة بين المساحة والسعر حسب مستوى الخطورة\n{المدينة} - {الهدف_الاستثماري}')
        plt.xlabel('المساحة (م²)')
        plt.ylabel('السعر (ريال)')
        st.pyplot(fig)
        
        # الرسم البياني 2: توزيع العائد حسب الخطورة
        fig2, ax2 = plt.subplots(figsize=(10, 5))
        sns.boxplot(data=df, x='مستوى_الخطورة', y='العائد_المتوقع_٪', palette='coolwarm')
        plt.title(f'توزيع العائد المتوقع حسب مستوى الخطورة\n{المدينة}')
        plt.xlabel('مستوى الخطورة')
        plt.ylabel('العائد المتوقع (%)')
        st.pyplot(fig2)
        
        # أفضل 5 عقارات موصى بها
        st.subheader("🏆 أفضل 5 عقارات موصى بها")
        أفضل_العقارات = df.nlargest(5, 'العائد_المتوقع_٪')
        st.dataframe(أفضل_العقارات[['العقار', 'الحي', 'السعر', 'المساحة', 'العائد_المتوقع_٪', 'مستوى_الخطورة']])
        
        # 📤 خيارات تحميل التقرير مع التاريخ
        st.subheader("📥 تحميل التقرير")
        
        now = datetime.now().strftime("%Y-%m-%d_%H-%M")
        
        col7, col8 = st.columns(2)
        
        with col7:
            # تحميل Excel
            excel_buffer = BytesIO()
            أفضل_العقارات.to_excel(excel_buffer, index=False)
            st.download_button(
                label="📊 تحميل البيانات Excel",
                data=excel_buffer.getvalue(),
                file_name=f"تقرير_{اسم_العميل}_{المدينة}_{now}.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
        
        with col8:
            # تحميل CSV
            csv_buffer = BytesIO()
            أفضل_العقارات.to_csv(csv_buffer, index=False, encoding='utf-8-sig')
            st.download_button(
                label="📄 تحميل البيانات CSV",
                data=csv_buffer.getvalue(),
                file_name=f"تقرير_{اسم_العميل}_{المدينة}_{now}.csv",
                mime="text/csv"
            )

# قسم الأسعار
st.markdown("---")
st.subheader("💰 التسعير المتخصص")

col7, col8, col9 = st.columns(3)
with col7:
    st.metric("الباقة الأساسية", "500$", "تحليل متخصص + توصيات")
with col8:
    st.metric("الباقة المتقدمة", "800$", "توصيات استراتيجية + متابعة")
with col9:
    st.metric("الباقة المميزة", "1,200$", "دراسة جدوى شاملة + استشارة")

# ❤️ لمسة شخصية في النهاية
st.markdown("---")
st.markdown("✨ شكرًا لاستخدامك منصة **وردة العقارية**! نتطلع لخدمتك مجددًا 💐")
st.markdown("📞 للتواصل: warda@realestate.com | 💼 متخصصون في التحليل الاستثماري المتقدم")

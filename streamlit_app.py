import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime

# โ ุงุณุชูุฑุงุฏ ุงููููุงุช ุงููุณุงุนุฏุฉ
from real_fetcher import fetch_real_data
from data_config import ุงูุฃุณุนุงุฑ_ุงูุญุงููุฉ, ุขุฎุฑ_ุชุญุฏูุซ, ููุงุทู_ุญููููุฉ

# ๐ก ูุงุฌูุฉ ุงูุชุทุจูู
st.set_page_config(page_title="ููุตุฉ ูุฑุฏุฉ ุงูุนูุงุฑูุฉ", page_icon="๐", layout="wide")

st.title("๐ ููุตุฉ ูุฑุฏุฉ ุงูุนูุงุฑูุฉ")
st.markdown("### ุงูุชุดู ุฃุญุฏุซ ุงูุฃุณุนุงุฑ ุงูุนูุงุฑูุฉ ูู ุงูุณุนูุฏูุฉ ๐ธ๐ฆ")

# โ ุฅุธูุงุฑ ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ ููุจูุงูุงุช ุงููุญููุฉ
st.sidebar.info(f"๐ ุขุฎุฑ ุชุญุฏูุซ ูุฏูู ููุจูุงูุงุช: {ุขุฎุฑ_ุชุญุฏูุซ}")

# ๐๏ธ ุงุฎุชูุงุฑ ุงููุฏููุฉ ูููุน ุงูุนูุงุฑ
ุงููุฏููุฉ = st.selectbox("ุงุฎุชุฑ ุงููุฏููุฉ:", list(ุงูุฃุณุนุงุฑ_ุงูุญุงููุฉ.keys()))
ููุน_ุงูุนูุงุฑ = st.selectbox("ุงุฎุชุฑ ููุน ุงูุนูุงุฑ:", ["ุดูู", "ููู", "ููุงุชุจ"])
ุงูุญู = st.selectbox("ุงุฎุชุฑ ุงูุญู:", ููุงุทู_ุญููููุฉ.get(ุงููุฏููุฉ, []))

# ๐ ุฒุฑ ุฅูุดุงุก ุงูุชูุฑูุฑ
if st.button("๐ ุฅูุดุงุก ุงูุชูุฑูุฑ ุงูุขู"):
    with st.spinner("ุฌุงุฑู ุฌูุจ ูุชุญููู ุงูุจูุงูุงุช..."):
        try:
            # ูุญุงููุฉ ุฌูุจ ุจูุงูุงุช ุญููููุฉ ูู ุงูุฅูุชุฑูุช
            ูุชุงุฆุฌ = fetch_real_data(ุงููุฏููุฉ, ููุน_ุงูุนูุงุฑ)
        except Exception as e:
            ูุชุงุฆุฌ = None
            st.error(f"โ๏ธ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฌูุจ ูู ุงูุฅูุชุฑูุช: {e}")

        # โ ุฅุฐุง ูุดู ุงูุฌูุจ ูุณุชุนูู ุงูุจูุงูุงุช ุงููุญููุฉ
        if not ูุชุงุฆุฌ:
            st.warning("โ๏ธ ูู ูุชููู ุงูุชุทุจูู ูู ุฌูุจ ุจูุงูุงุช ูุจุงุดุฑุฉุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ ุงูุญุงููุฉ.")
            ุจูุงูุงุช = ุงูุฃุณุนุงุฑ_ุงูุญุงููุฉ[ุงููุฏููุฉ][ููุน_ุงูุนูุงุฑ]
        else:
            ุจูุงูุงุช = ูุชุงุฆุฌ

        # ๐ฐ ุนุฑุถ ุงููุชุงุฆุฌ
        st.success(f"๐ ุชู ุฅุนุฏุงุฏ ุงูุชูุฑูุฑ ููุฏููุฉ **{ุงููุฏููุฉ}** - ููุน ุงูุนูุงุฑ **{ููุน_ุงูุนูุงุฑ}**")

        col1, col2, col3 = st.columns(3)
        col1.metric("๐ฐ ูุชูุณุท ุงูุณุนุฑ", f"{ุจูุงูุงุช['ูุชูุณุท_ุงูุณุนุฑ']:,} ุฑูุงู")
        col2.metric("๐ ุฃุนูู ุณุนุฑ", f"{ุจูุงูุงุช['ูุทุงู_ุงูุณุนุฑ'][1]:,} ุฑูุงู")
        col3.metric("๐ ุฃูู ุณุนุฑ", f"{ุจูุงูุงุช['ูุทุงู_ุงูุณุนุฑ'][0]:,} ุฑูุงู")

        # ๐ข ุฅูุดุงุก ุจูุงูุงุช ุชุญููููุฉ ููููุฉ ุญูู ุงูุฃุณุนุงุฑ
        np.random.seed(42)
        data = pd.DataFrame({
            "ุงูุณุนุฑ": np.random.normal(ุจูุงูุงุช["ูุชูุณุท_ุงูุณุนุฑ"], ุจูุงูุงุช["ูุชูุณุท_ุงูุณุนุฑ"] * 0.2, 100).astype(int),
            "ุงูุญู": np.random.choice(ููุงุทู_ุญููููุฉ[ุงููุฏููุฉ], 100)
        })

        # ๐ ุฑุณู ุจูุงูู
        st.markdown("### ุชูุฒูุน ุงูุฃุณุนุงุฑ ุญุณุจ ุงูุฃุญูุงุก ๐")
        st.bar_chart(data.groupby("ุงูุญู")["ุงูุณุนุฑ"].mean())

        # ๐ง ุชูุจุค ุจุณูุท ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู (ูููุฐุฌ ุชุฌุฑูุจู)
        st.markdown("### ๐ค ุงูุชูุจุค ุงูุฐูู ุจุณุนุฑ ุงูุนูุงุฑ ุงููุงุฏู:")
        ุงูุชูุจุค = round(ุจูุงูุงุช["ูุชูุณุท_ุงูุณุนุฑ"] * np.random.uniform(0.95, 1.10))
        st.info(f"๐ฎ ูู ุงููุชููุน ุฃู ูููู ุงูุณุนุฑ ุงููุงุฏู ูู {ุงูุญู} ุญูุงูู **{ุงูุชูุจุค:,} ุฑูุงู**")

        st.caption("๐ก ููุงุญุธุฉ: ูุฐู ุงูุชูุจุคุงุช ุชุนุชูุฏ ุนูู ุชุญููู ุงูุจูุงูุงุช ุงูุญุงููุฉ ูู

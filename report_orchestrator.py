# report_orchestrator.py
# =========================================
# Central Report Orchestrator โ Warda Intelligence
# ูุจูู ุงููุต ุงูููุงุฆู ููุชูุฑูุฑ ูุจู ุชุญูููู ุฅูู PDF
# =========================================

from datetime import datetime
from ai_executive_summary import generate_executive_summary, FinalDecision
from ai_report_reasoner import AIReportReasoner
from report_content_builder import build_complete_report


def build_report_story(user_info, market_data, real_data):
    """
    ูุจูู ุงููุต ุงููุงูู ููุชูุฑูุฑ (content_text)
    ุจุงูุชุฑุชูุจ ุงูููุทููุ ูุน ูุฑุงุฑ ุชูููุฐู ูุงุถุญ ููุณุชูู
    """

    # =========================
    # 1๏ธโฃ ุงููุญุชูู ุงูุฃุณุงุณู (ุงููุตูู)
    # =========================
    report_structure = build_complete_report(user_info)
    content_text = ""

    for chapter in report_structure["chapters"]:
        for block in chapter["blocks"]:
            if block["type"] in ("rich_text", "chapter_title"):
                content_text += block["content"].strip() + "\n\n"

    # =========================
    # 2๏ธโฃ ุชูููู ุงูุจูุงูุงุช (ูุต ูุธูู โ ูุง Markdown)
    # =========================
    content_text += (
        "๐ ุชูููู ููู ุญูู ุงูุจูุงูุงุช:\n"
        "ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุงุนุชูุงุฏูุง ุนูู ุจูุงูุงุช ุณูููุฉ ุญูุฉ ููุจุงุดุฑุฉุ "
        "ุชู ุฌูุนูุง ูุชุญููููุง ุขูููุง ูู ูุญุธุฉ ุฅุนุฏุงุฏ ุงูุชูุฑูุฑุ "
        "ูุชุนูุณ ุญุงูุฉ ุงูุณูู ูู ููุช ุงูุฅูุดุงุก ููุท. "
        "ุฃู ุชุบููุฑ ูุงุญู ูู ุงูุณูู ูุฏ ูุคุซุฑ ุนูู ุตูุงุญูุฉ ุงูุงุณุชูุชุงุฌุงุช.\n\n"
    )

    # =========================
    # 3๏ธโฃ ุชูููุฏ ุงููุฑุงุฑ ุงูุชูููุฐู ุงูุญูููู
    # =========================
    final_decision: FinalDecision = generate_executive_summary(
        user_info, market_data, real_data, return_object=True
    )

    # =========================
    # 4๏ธโฃ ุตูุงุบุฉ ูุฑุงุฑ ุจูุณุชูู 10,000$
    # =========================
    decision_text = f"""
ุงููุฑุงุฑ ุงูุชูููุฐู ุงูููุงุฆู

ุงููุฏููุฉ: {user_info.get("city", "โ")}
ููุน ุงูุฃุตู: {user_info.get("property_type", "โ")}

ุงูุชูุตูุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ:
{final_decision.action}

ุฏุฑุฌุฉ ุงูุซูุฉ ูู ุงููุฑุงุฑ:
{int(final_decision.confidence * 100)}%

ุงูุฃูู ุงูุฒููู ุงูููุงุณุจ:
{final_decision.horizon}

ุงูููุทู ุงูุฐู ุจููู ุนููู ุงููุฑุงุฑ:
"""

    for r in final_decision.rationale:
        decision_text += f"- {r}\n"

    decision_text += "\nุงููุฎุงุทุฑ ุงูุชู ูุฌุจ ุฅุฏุฑุงููุง:\n"
    for risk in final_decision.risks:
        decision_text += f"- {risk}\n"

    # =========================
    # 5๏ธโฃ ูุงุฐุง ููุนู ุงููุณุชุซูุฑ ุจุนุฏ ุฅุบูุงู ุงูุชูุฑูุฑุ
    # =========================
    if final_decision.action == "BUY":
        decision_text += """
ููู ุชุชุตุฑู ุจุนุฏ ูุฐุง ุงููุฑุงุฑ:
- ุฑููุฒ ููุท ุนูู ุงูุฃุตูู ุงูุชู ุชุญูู ููุณ ุงููุฑุถูุงุช ุงูุชู ุจููู ุนูููุง ุงููุฑุงุฑ.
- ุชูุงูุถ ุฏุงุฆููุง ุนูู ุงูุณุนุฑ ุญุชู ูู ุจุฏุง "ุนุงุฏููุง".
- ูุง ุชูุณูุน ุญุฌู ุงูุงูุชุฒุงู ูุจู ูุฑูุฑ ุฃูู 6โ9 ุฃุดูุฑ ูู ุงูุงุณุชูุฑุงุฑ.
- ุฑุงูุจ ุงููุคุดุฑุงุช ุงูุชุดุบูููุฉ ูุง ุงูุนูุงููู ุงูุฅุนูุงููุฉ.
"""
    else:
        decision_text += """
ูุง ุงูุฐู ูููุตุญ ุจู ุจุฏู ุงูุชูููุฐ ุงูุขู:
- ุนุฏู ุงูุดุฑุงุก ุฃู ุงูุงูุชุฒุงู ูู ุงููุถุน ุงูุญุงูู.
- ูุฑุงูุจุฉ ูุคุดุฑุงุช ูุญุฏุฏุฉ ููุท ุฏูู ุงูุดุบุงู ูููู ุจุงูุณูู.
- ุงูุชุธุงุฑ ุชุญุณูู ุดุฑูุท ุงูุฏุฎูู ุฃู ุชุบููุฑ ุงููุฑุถูุงุช ุงูุฃุณุงุณูุฉ.
- ุงูุงุณุชุนุฏุงุฏ ุงูุณุฑูุน ููุชูููุฐ ุฅุฐุง ุชุญููุช ุฅุดุงุฑุงุช ุงูุชุบููุฑ.
"""

    # =========================
    # 6๏ธโฃ ุฅุฏุฎุงู ุงููุฑุงุฑ ุจุนูุงูุฉ ๐ (Trigger ููู PDF)
    # =========================
    content_text += "\n๐\n"
    content_text += decision_text.strip() + "\n\n"

    # =========================
    # 7๏ธโฃ ุตูุญุฉ ุชุงุฑูุฎ ุฅูุดุงุก ุงูุชูุฑูุฑ
    # =========================
    content_text += (
        "๐\n"
        "ุชุงุฑูุฎ ุฅูุดุงุก ุงูุชูุฑูุฑ\n\n"
        f"ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ูู: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n"
        "ุจุงุณุชุฎุฏุงู ุจูุงูุงุช ุณูููุฉ ุญููููุฉ ุฌููุนุช ูุญูููุช ุขูููุง.\n"
    )

    return content_text

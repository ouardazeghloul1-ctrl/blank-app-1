# ai_executive_summary.py
# =========================================
# Executive Decision Engine โ Warda Intelligence
# ุฎูุงุตุฉ ุงุณุชุดุงุฑูุฉ ุชูููุฐูุฉ ุญุงุณูุฉ
# ูุจููุฉ ุนูู ุจูุงูุงุช ูุนููุฉ + Smart Opportunities
# =========================================

import pandas as pd
from smart_opportunities import SmartOpportunityFinder


def generate_executive_summary(user_info, market_data, real_data):
    """
    ูููุฏ ุฎูุงุตุฉ ุงุณุชุดุงุฑูุฉ ุชูููุฐูุฉ ููุงุฆูุฉ
    ูุฑุงุฑ ูุงุถุญ ููููุฒูู: ูุนู / ุงูุชุธุฑ / ูุง
    ุจุฏูู ูุฎุงุทุจุฉ ุฃู ูุฆุฉ
    """

    # =========================
    # ๐ก๏ธ ุญูุงูุฉ ุฃุณุงุณูุฉ
    # =========================
    if real_data is None or real_data.empty:
        return (
            "โ ุชุนุฐุฑ ุฅุตุฏุงุฑ ุฎูุงุตุฉ ุงุณุชุดุงุฑูุฉ ููุซููุฉ ุจุณุจุจ ุบูุงุจ ุงูุจูุงูุงุช ุงููุนููุฉ.\n"
            "ูุง ูููุตุญ ุจุงุชุฎุงุฐ ุฃู ูุฑุงุฑ ูุจู ุชููุฑ ุจูุงูุงุช ุณูููุฉ ุญููููุฉ ูุงุจูุฉ ููุชุญููู."
        )

    city = user_info.get("city", "ุงููุฏููุฉ")
    property_type = user_info.get("property_type", "ุงูุนูุงุฑ")

    # =========================
    # ๐ ุงูุฃุณุงุณ ุงูุฑููู
    # =========================
    total_properties = len(real_data)

    avg_price_m2 = real_data["ุณุนุฑ_ุงููุชุฑ"].mean()
    min_price_m2 = real_data["ุณุนุฑ_ุงููุชุฑ"].min()
    max_price_m2 = real_data["ุณุนุฑ_ุงููุชุฑ"].max()

    avg_return = (
        real_data["ุงูุนุงุฆุฏ_ุงููุชููุน"].mean()
        if "ุงูุนุงุฆุฏ_ุงููุชููุน" in real_data.columns
        else None
    )

    # =========================
    # ๐ง ูุญุฑู ุงููุฑุต ุงูุฐููุฉ
    # =========================
    finder = SmartOpportunityFinder()

    undervalued = finder.find_undervalued_properties(real_data, city)
    rising_areas = finder.predict_rising_areas(real_data, city)
    timing = finder.get_golden_timing(market_data)

    undervalued_count = len(undervalued)

    best_discount = (
        max(float(o["ุงูุฎุตู"].replace("%", "")) for o in undervalued)
        if undervalued else 0
    )

    top_areas = [a["ุงูููุทูุฉ"] for a in rising_areas[:3]]

    # =========================
    # ๐ ูุคุดุฑุงุช ุงูุณูู
    # =========================
    growth = market_data.get("ูุนุฏู_ุงูููู_ุงูุดูุฑู", 0)
    liquidity = market_data.get("ูุคุดุฑ_ุงูุณูููุฉ", 0)

    # =========================
    # ๐ฆ ููุทู ุงููุฑุงุฑ ุงูุชูููุฐู
    # =========================
    decision = "ุงูุชุธุฑ"
    rationale = ""

    if undervalued_count >= 3 and best_discount >= 15 and liquidity >= 60:
        decision = "ูุนู"
        rationale = (
            "ุชู ุฑุตุฏ ูุฌูุงุช ุณุนุฑูุฉ ุญููููุฉ ุจุฎุตููุงุช ุชุชุฌุงูุฒ 15% "
            "ุถูู ููุงุทู ุชูุธูุฑ ููููุง ุชุดุบููููุง ูุนูููุง ูุณูููุฉ ููุจููุฉ."
        )

    elif liquidity < 50 or growth < 1:
        decision = "ูุง"
        rationale = (
            "ุงูุณูููุฉ ุฃู ุงูููู ุงูุญุงูู ูุง ูุฏุนูุงู ุฏุฎูููุง ุขูููุงุ "
            "ูุงุญุชูุงู ุชุขูู ุงูุนุงุฆุฏ ุฃุนูู ูู ูุฑุต ุงูุชุญุณู."
        )

    else:
        decision = "ุงูุชุธุฑ"
        rationale = (
            "ุงูุณูู ุงูุชูุงุฆู ูุงููุฑุต ุงููุญุฏุฏุฉ ุบูุฑ ูุงููุฉ ูุงุชุฎุงุฐ ูุฑุงุฑ ุญุงุณู ุญุงูููุง. "
            "ุงูุงูุชุธุงุฑ ูุฏ ููุดู ูุฌูุงุช ุฃูุถุญ."
        )

    # =========================
    # ๐ ุงููุต ุงูุชูููุฐู ุงูููุงุฆู
    # =========================
    summary = f"""
๐ ุงูุฎูุงุตุฉ ุงูุงุณุชุดุงุฑูุฉ ุงูุชูููุฐูุฉ
{city} โ {property_type}

โโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุฃุณุงุณ ุงูุฑููู
โโโโโโโโโโโโโโโโโโโโโโโโ
โข ุชู ุชุญููู {total_properties} ุนูุงุฑูุง ูุนูููุง
โข ูุชูุณุท ุณุนุฑ ุงููุชุฑ: {avg_price_m2:,.0f} ุฑูุงู
โข ุงููุทุงู ุงูุณุนุฑู: {min_price_m2:,.0f} โ {max_price_m2:,.0f} ุฑูุงู/ูยฒ
{f"โข ูุชูุณุท ุงูุนุงุฆุฏ ุงููุชููุน: {avg_return:.1f}%" if avg_return else ""}

โโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูุง ุงูุฐู ูุดูุชู ุงูุจูุงูุงุช
โโโโโโโโโโโโโโโโโโโโโโโโ
โข ุนุฏุฏ ุงูุนูุงุฑุงุช ุฏูู ุณุนุฑ ุงูุณูู: {undervalued_count}
โข ุฃุนูู ุฎุตู ูุนูู ููุชุดู: {best_discount:.1f}%
โข ุงูููุงุทู ุงูุฃูุซุฑ ุฌุงุฐุจูุฉ ุญุงูููุง:
  {", ".join(top_areas) if top_areas else "ูุง ุชูุฌุฏ ููุงุทู ูุงุถุฌุฉ ุญุงูููุง"}

โโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูุฑุงุกุฉ ุงูุณูู
โโโโโโโโโโโโโโโโโโโโโโโโ
โข ูุนุฏู ุงูููู ุงูุดูุฑู: {growth:.1f}%
โข ูุคุดุฑ ุงูุณูููุฉ: {liquidity:.0f}
โข ุชูููู ุงูุชูููุช: {timing}

โโโโโโโโโโโโโโโโโโโโโโโโ
๐ฆ ุงููุฑุงุฑ ุงูุงุณุชุดุงุฑู ุงูููุงุฆู
โโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงููุฑุงุฑ: **{decision}**

{rationale}

โโโโโโโโโโโโโโโโโโโโโโโโ
๐ง ูุง ูุนููู ูุฐุง ุงููุฑุงุฑ ุนููููุง
โโโโโโโโโโโโโโโโโโโโโโโโ
โข ุงูุฏุฎูู ูููู ููุท ุนูุฏ ุฎุตู ุญูููู ููุงุจู ูุชูุณุท ุงูููุทูุฉ
โข ุงูุณุนุฑ ุงููุฑุฌุนู ูู ุณุนุฑ ุงููุชุฑ ุงููุนูู ูุง ุณุนุฑ ุงูุฅุนูุงู
โข ุงูุฃููููุฉ ููููุงุทู ุงูุชู ุชูุธูุฑ ุชุญุณููุง ุชุดุบููููุง ูุง ุถุฌูุฌูุง ุฅุนูุงูููุง
โข ุฃู ูุฑุงุฑ ุฎุงุฑุฌ ูุฐู ุงููุนุงููุฑ ููุนุฏ ูุฎุงุทุฑุฉ ุบูุฑ ูุจุฑุฑุฉ

๐ ุตุงูุญ ูููุฑุงุฌุนุฉ ุฎูุงู 3โ6 ุฃุดูุฑ
๐ ูุจูู ุนูู ุจูุงูุงุช ูุนููุฉ ูุง ุชููุนุงุช ูุธุฑูุฉ
"""

    return summary.strip()

# ai_executive_summary.py
# =========================================
# Executive Predictive Decision Engine
# Warda Intelligence โ Diamond Tier
# =========================================

from smart_opportunities import SmartOpportunityFinder
import numpy as np
import pandas as pd


def safe_pct(x, default=0.0):
    return round(float(x * 100), 2) if pd.notna(x) else default


def generate_executive_summary(user_info, market_data, real_data):
    """
    ุงูุฎูุงุตุฉ ุงูุชูููุฐูุฉ ุงูุชูุจุคูุฉ โ ูุจููุฉ ุนูู 6 ูุชู ุซุงุจุชุฉ
    ูู ุงูููู ูุงุชุฌุฉ ุนู ุจูุงูุงุช ุญูุฉ + ุชุญููู ุฐูุงุก ุงุตุทูุงุนู
    """

    if real_data is None or real_data.empty:
        return (
            "ุชุนุฐุฑ ุชูููุฏ ุงูุฎูุงุตุฉ ุงูุชูููุฐูุฉ ุงูุชูุจุคูุฉ ูุนุฏู ุชููุฑ ุจูุงูุงุช ุณูููุฉ ุญููููุฉ.\n"
            "ูุธุงู Warda Intelligence ูุนูู ููุท ุนูุฏ ุชููุฑ ุจูุงูุงุช ูุงุจูุฉ ููุชุญููู."
        )

    city = user_info.get("city", "ุงููุฏููุฉ")

    # =========================
    # ุงุณุชุฎุฑุงุฌ ุงูุฅุดุงุฑุงุช ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    # =========================
    finder = SmartOpportunityFinder()
    undervalued = finder.find_undervalued_properties(real_data, city)
    rising_areas = finder.predict_rising_areas(real_data, city)

    liquidity = market_data.get("ูุคุดุฑ_ุงูุณูููุฉ", 50)
    growth = market_data.get("ูุนุฏู_ุงูููู_ุงูุดูุฑู", 0.0)

    # =========================
    # ุญุณุงุจ ูุคุดุฑุงุช ุณููููุฉ ุฅุถุงููุฉ
    # =========================
    volatility = safe_pct(real_data["price"].pct_change().std(), 0.5)
    activity_score = min(100, max(20, liquidity))
    selectivity_score = min(10, max(1, len(undervalued)))

    positive_signals = len(undervalued) + len(rising_areas)
    negative_signals = 1 if volatility > 2 else 0

    # =========================
    # ุทุจูุฉ ุงูุชูุจุค ุงูุงุญุชูุงูู (Prediction Layer)
    # =========================
    p_3m = int((0.55 + (growth / 10)) * 100)
    p_6m = int((0.60 + (liquidity / 200)) * 100)
    p_12m = int((0.65 + (len(undervalued) / 10)) * 100)

    p_3m = min(max(p_3m, 45), 85)
    p_6m = min(max(p_6m, 50), 90)
    p_12m = min(max(p_12m, 55), 95)

    # =========================
    # ุจูุงุก ุงูุฎูุงุตุฉ โ ุงููุชู ุงูุณุช
    # =========================
    lines = []

    # ๐งฑ ุงููุชูุฉ (1): ุชุนุฑูู ุงููุฑุงุฑ ุงูุชูุจุคู
    lines.append("๐ ุงูุฎูุงุตุฉ ุงูุชูููุฐูุฉ ุงูุชูุจุคูุฉ โ Warda Intelligence")
    lines.append("")
    lines.append(
        "ูุฐุง ุงููุฑุงุฑ ูุงุชุฌ ุนู ูุธุงู ุฐูุงุก ุงุตุทูุงุนู ุชูุจุคูุ "
        "ูุจูู ุนูู ุจูุงูุงุช ุณูููุฉ ุญูุฉุ ููุงุฑูุฉ ุชุงุฑูุฎูุฉุ "
        "ุฑุตุฏ ูุฌูุงุช ูููุฉุ ูุชุญููู ุณููู ูุนูู ููุณูู."
    )
    lines.append("ูุง ูุนุชูุฏ ุนูู ุขุฑุงุก ุจุดุฑูุฉ ุฃู ุชูุตูุงุช ุนุงูุฉ.")
    lines.append("")

    # ๐งฑ ุงููุชูุฉ (2): ูุถุน ุงูุณูู ุงูุญุงูู ุจุงูุฃุฑูุงู
    lines.append("๐ ูุถุน ุงูุณูู ุงูุญุงูู (ูุฑุงุกุฉ ุฑูููุฉ):")
    lines.append(f"- ููุฉ ุงููุดุงุท ุงูุณููู: {activity_score}%")
    lines.append(f"- ุฏุฑุฌุฉ ุงูุงูุชูุงุฆูุฉ: {selectivity_score}/10")
    lines.append(
        f"- ูุณุชูู ุงูุชุฐุจุฐุจ: "
        f"{'ููุฎูุถ' if volatility < 1 else 'ูุชูุณุท' if volatility < 2 else 'ูุฑุชูุน'}"
    )
    lines.append(
        f"- ุงูุฅุดุงุฑุงุช ุงูุฅูุฌุงุจูุฉ ููุงุจู ุงูุณูุจูุฉ: "
        f"{positive_signals} / {negative_signals}"
    )
    lines.append("")

    # ๐งฑ ุงููุชูุฉ (3): ุงูุฅุดุงุฑุงุช ุงูุชูุจุคูุฉ
    lines.append("๐ฎ ุงูุฅุดุงุฑุงุช ุงูุชูุจุคูุฉ (Prediction Layer):")
    lines.append(
        f"- ุฎูุงู 3 ุฃุดูุฑ: ุงุณุชูุฑุงุฑ ุงูุชูุงุฆู ุจุงุญุชูุงููุฉ โ {p_3m}%"
    )
    lines.append(
        f"- ุฎูุงู 6 ุฃุดูุฑ: ุชุญุณู ููุถุนู ุจุงุญุชูุงููุฉ โ {p_6m}%"
    )
    lines.append(
        f"- ุฎูุงู 12 ุดูุฑ: ุฅุนุงุฏุฉ ุชุณุนูุฑ ูุงุฆูุฉ ุนูู ุงููููุฉ ุจุงุญุชูุงููุฉ โ {p_12m}%"
    )
    lines.append("")

    # ๐งฑ ุงููุชูุฉ (4): ุงูุณููุงุฑูููุงุช ุงูุฐููุฉ
    lines.append("๐ง ุงูุณููุงุฑูููุงุช ุงููุญุชููุฉ (What If):")
    lines.append(
        "- ุฅุฐุง ุจูู ุงููุถุน ููุง ูู: ุงููุฑุงุฑ ุงูุญุงูู ูุธู ุตุงูุญูุง ุฏูู ุชุนุฏูู."
    )
    lines.append(
        "- ุฅุฐุง ุชุญุณูู ุงูุณูู: ุชุชูุณุน ูุณุงุญุฉ ุงูุญุฑูุฉ ุฏูู ุชุบููุฑ ุฌููุฑ ุงููุฑุงุฑ."
    )
    lines.append(
        "- ุฅุฐุง ุณุงุก ุงูุณูู: ูุชุญูู ุงููุฑุงุฑ ุชููุงุฆููุง ุฅูู ูุถุน ุญูุงูุฉ ุฏูู ูุฏู."
    )
    lines.append("")

    # ๐งฑ ุงููุชูุฉ (5): ุงููุฑุงุฑ ุงูููุงุฆู (ุจุฏูู ุชุณููุชู)
    lines.append("๐งญ ุงููููู ุงูุฃูุซู ุงูุขู:")
    if liquidity >= 60 and len(undervalued) >= 3:
        lines.append(
            "- ุชููุถุน ูุณูุญ ุจุงูุญุฑูุฉ ุงููุงุฏุฆุฉ ุถูู ูุทุงู ูุญุณูุจ."
        )
    elif liquidity < 45:
        lines.append(
            "- ุชุซุจูุช ุงููููุน ุงูุญุงูู ูุน ูุฑููุฉ ุนุงููุฉ ููุชุบููุฑ."
        )
    else:
        lines.append(
            "- ุฌุงูุฒูุฉ ูุงููุฉ ุฏูู ุงูุชุฒุงู ุญุชู ูุถูุฌ ุงูุฅุดุงุฑุงุช."
        )
    lines.append("")

    # ๐งฑ ุงููุชูุฉ (6): ุถูุงู ุงููุฑุงุฑ
    lines.append("๐ก๏ธ ุถูุงู ุงููุฑุงุฑ (ููุณู + ููุทูู):")
    lines.append(
        "- ูุง ุชุญุชุงุฌ ูุฅุนุงุฏุฉ ุงูุชูููุฑ ุทุงููุง ูู ุชุชุบูุฑ ุงููุคุดุฑุงุช ุฃุนูุงู."
    )
    lines.append(
        "- ุฃุนุฏ ุงูุชูููู ููุท ุนูุฏ ุชุบููุฑ ุงูุณูููุฉ ุฃู ุงุฎุชูุงุก ูุฌูุงุช ุงููููุฉ."
    )
    lines.append(
        "- ุชุฌุงูู ุงูุถุฌูุฌ ูุตูุฑ ุงููุฏูุ ูุฐุง ุงููุฑุงุฑ ุตููู ููุตูุฏ."
    )
    lines.append("")
    lines.append("โ")
    lines.append(
        "ูููุฉ ูุฐุง ุงููุฑุงุฑ ุฃูู ูุญููู ูู ุงูุฎุทุฃ "
        "ุฃูุซุฑ ููุง ูุนุฏู ุจููุณุจ ูุญุธู."
    )

    return "\n".join(lines)

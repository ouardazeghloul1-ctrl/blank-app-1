# ai_executive_summary.py
# =========================================
# Executive Decision Engine โ Warda Intelligence
# ุฎูุงุตุฉ ุงุณุชุดุงุฑูุฉ ุชูููุฐูุฉ ูููุฒููุฉ ููุณููุง
# ูุจููุฉ ุนูู ุจูุงูุงุช ูุนููุฉ + Smart Opportunities
# =========================================

from smart_opportunities import SmartOpportunityFinder


def generate_executive_summary(user_info, market_data, real_data):
    """
    ูููุฏ ุฎูุงุตุฉ ุงุณุชุดุงุฑูุฉ ููุงุฆูุฉ:
    - ูุฑุงุฑ ูุงุถุญ (ูุนู / ุงูุชุธุฑ / ูุง)
    - ุฎุทูุงุช ุนูููุฉ
    - ุฃุฑูุงู ุญููููุฉ
    - ุจุฏูู ูุฎุงุทุจุฉ ูุฆุฉ ูุนููุฉ
    """

    # =============================
    # 1๏ธโฃ ุญูุงูุฉ ุฃุณุงุณูุฉ
    # =============================
    if real_data is None or real_data.empty:
        return (
            "โ ุชุนุฐุฑ ุชูููุฏ ุฎูุงุตุฉ ุงุณุชุดุงุฑูุฉ ุฏูููุฉ ุจุณุจุจ ุบูุงุจ ุงูุจูุงูุงุช ุงููุนููุฉ.\n\n"
            "ูุฐุง ุงูุชูุฑูุฑ ูุง ููุตู ุจุงุชุฎุงุฐ ุฃู ูุฑุงุฑ ูู ุธู ุนุฏู ุชููุฑ ุจูุงูุงุช ุณูููุฉ ููุซููุฉุ "
            "ููููุตุญ ุจุฅุนุงุฏุฉ ุงูุชูููู ููุฑ ุชููุฑ ุจูุงูุงุช ุญููููุฉ ูุญุฏุซุฉ."
        )

    city = user_info.get("city", "ุงููุฏููุฉ")
    property_type = user_info.get("property_type", "ุงูุนูุงุฑ")

    # =============================
    # 2๏ธโฃ ุงูุฃุณุงุณ ุงูุฑููู (Facts)
    # =============================
    total_properties = len(real_data)

    avg_price_m2 = real_data["ุณุนุฑ_ุงููุชุฑ"].mean()
    min_price_m2 = real_data["ุณุนุฑ_ุงููุชุฑ"].min()
    max_price_m2 = real_data["ุณุนุฑ_ุงููุชุฑ"].max()

    # =============================
    # 3๏ธโฃ ุงูุนูู ุงูุฐูู (Smart Opportunities)
    # =============================
    finder = SmartOpportunityFinder()

    undervalued_props = finder.find_undervalued_properties(real_data, city)
    rising_areas = finder.predict_rising_areas(real_data, city)
    golden_timing = finder.get_golden_timing(market_data)

    undervalued_count = len(undervalued_props)

    best_discount = (
        max([float(o["ุงูุฎุตู"].replace("%", "")) for o in undervalued_props])
        if undervalued_props else 0
    )

    top_areas = [a["ุงูููุทูุฉ"] for a in rising_areas[:3]]

    # =============================
    # 4๏ธโฃ ูุคุดุฑุงุช ุงูุณูู ุงูุนุงูุฉ
    # =============================
    growth = market_data.get("ูุนุฏู_ุงูููู_ุงูุดูุฑู", 0)
    liquidity = market_data.get("ูุคุดุฑ_ุงูุณูููุฉ", 0)

    # =============================
    # 5๏ธโฃ ููุทู ุงููุฑุงุฑ ุงูุญุงุณู
    # =============================
    decision = "ุงูุชุธุฑ"
    decision_reason = ""
    action_plan = ""

    if undervalued_count >= 2 and best_discount >= 15 and liquidity >= 60:
        decision = "ูุนู"
        decision_reason = (
            "ุชู ุฑุตุฏ ูุฌูุงุช ุณุนุฑูุฉ ุญููููุฉ ุชุชุฌุงูุฒ 15% "
            "ุถูู ููุงุทู ุชูุธูุฑ ููููุง ุชุดุบููููุง ูุนูููุงุ "
            "ูุน ูุณุชูู ุณูููุฉ ูุณูุญ ุจุงูุฏุฎูู ุงูุขูู."
        )

        action_plan = (
            "โข ุงูุชุฑููุฒ ููุท ุนูู ุงูุนูุงุฑุงุช ุงูุชู ููู ุณุนุฑ ุงููุชุฑ ูููุง ุนู "
            f"{avg_price_m2:,.0f} ุฑูุงู.\n"
            "โข ุงุณุชุจุนุงุฏ ุฃู ุตููุฉ ุชูู ุฎุตููุชูุง ุนู 12โ15% ูู ูุชูุณุท ุงูููุทูุฉ.\n"
            f"โข ุฅุนุทุงุก ุฃููููุฉ ููููุงุทู ุงูุชุงููุฉ: {', '.join(top_areas) if top_areas else 'โ'}.\n"
            "โข ุชูููุฐ ุงููุฑุงุฑ ุฎูุงู 30โ60 ููููุง ูุจู ุงูููุงุด ุงููุฌูุฉ ุงูุณุนุฑูุฉ."
        )

    elif liquidity < 50 or growth < 1:
        decision = "ูุง"
        decision_reason = (
            "ูุณุชูู ุงูุณูููุฉ ุฃู ุงูููู ุงูุญุงูู ูุง ูุฏุนู ุงูุฏุฎูู ุงูุขููุ "
            "ูุงููุฎุงุทุฑ ุงูุชุดุบูููุฉ ุฃุนูู ูู ุงูุนุงุฆุฏ ุงููุชููุน."
        )

        action_plan = (
            "โข ุชุฌููุฏ ุฃู ูุฑุงุฑ ุดุฑุงุก ูู ุงูููุช ุงูุญุงูู.\n"
            "โข ูุฑุงูุจุฉ ุชุญุณู ุงูุณูููุฉ ุฃู ุธููุฑ ุฎุตููุงุช ุญููููุฉ.\n"
            "โข ุฅุนุงุฏุฉ ุงูุชูููู ุนูุฏ ุชุฌุงูุฒ ุงูููู 1.5% ุฃู ุชุญุณู ุงูุณูููุฉ."
        )

    else:
        decision = "ุงูุชุธุฑ"
        decision_reason = (
            "ุงูุณูู ุงูุชูุงุฆู ุญุงูููุงุ ูุงููุฑุต ุงูุฌูุฏุฉ ููุฌูุฏุฉ ูููููุง ูุญุฏูุฏุฉุ "
            "ูุงูุงูุชุธุงุฑ ูุฏ ููุดู ูุฌูุงุช ุณุนุฑูุฉ ุฃูุถุญ."
        )

        action_plan = (
            "โข ูุฑุงูุจุฉ ุงูุณูู ุฏูู ุงูุชุฒุงู ููุฑู.\n"
            "โข ุฅุนุฏุงุฏ ูุงุฆูุฉ ูุตูุฑุฉ ุจุงูุนูุงุฑุงุช ุงููุฑูุจุฉ ูู ุงูุฎุตู ุงููุทููุจ.\n"
            "โข ุฅุนุงุฏุฉ ุงูุชูููู ุฎูุงู 60โ90 ููููุง."
        )

    # =============================
    # 6๏ธโฃ ุงููุต ุงูุชูููุฐู ุงูููุงุฆู (ูุงุฎุฑ + ูุงุถุญ)
    # =============================
    summary = f"""
๐ ุงูุฎูุงุตุฉ ุงูุงุณุชุดุงุฑูุฉ ุงูุชูููุฐูุฉ
{city} โ {property_type}

โโโโโโโโโโโโโโโโโโโโ
๐ ุงูุฃุณุงุณ ุงูุฑููู ูููุฑุงุฑ
โโโโโโโโโโโโโโโโโโโโ
โข ุชู ุชุญููู {total_properties} ุนูุงุฑูุง ูุนูููุง
โข ูุชูุณุท ุณุนุฑ ุงููุชุฑ: {avg_price_m2:,.0f} ุฑูุงู
โข ุงููุทุงู ุงูุณุนุฑู: {min_price_m2:,.0f} โ {max_price_m2:,.0f} ุฑูุงู/ูยฒ

โโโโโโโโโโโโโโโโโโโโ
๐ ูุง ุงูุฐู ุงูุชุดูู ุงููุธุงู ุงูุฐูู
โโโโโโโโโโโโโโโโโโโโ
โข ุนุฏุฏ ุงูุนูุงุฑุงุช ุงููุณุนูุฑุฉ ุฏูู ุงูุณูู: {undervalued_count}
โข ุฃุนูู ุฎุตู ูุนูู ููุชุดู: {best_discount:.1f}%
โข ุงูููุงุทู ุงูุฃูุซุฑ ุฌุงุฐุจูุฉ ุญุงูููุง:
  {", ".join(top_areas) if top_areas else "โ"}

โโโโโโโโโโโโโโโโโโโโ
๐ ูุฑุงุกุฉ ูุถุน ุงูุณูู ุงูุญุงูู
โโโโโโโโโโโโโโโโโโโโ
โข ูุนุฏู ุงูููู ุงูุดูุฑู: {growth:.1f}%
โข ูุคุดุฑ ุงูุณูููุฉ: {liquidity:.0f}
โข ุชูููู ุงูุชูููุช: {golden_timing}

โโโโโโโโโโโโโโโโโโโโ
๐ฆ ุงููุฑุงุฑ ุงูุงุณุชุดุงุฑู ุงูุญุงุณู
โโโโโโโโโโโโโโโโโโโโ
๐ ุงููุฑุงุฑ ุงูุญุงูู: **{decision}**

๐ง ููุทู ุงููุฑุงุฑ:
{decision_reason}

โโโโโโโโโโโโโโโโโโโโ
๐๏ธ ูุง ุงูุฐู ูุฌุจ ูุนูู ุงูุขู
โโโโโโโโโโโโโโโโโโโโ
{action_plan}

โโโโโโโโโโโโโโโโโโโโ
๐ ููุงุญุธุงุช ุชูููุฐูุฉ
โโโโโโโโโโโโโโโโโโโโ
โข ูุฐู ุงูุฎูุงุตุฉ ุชู ุชูููุฏูุง ุจุงุณุชุฎุฏุงู ูุธุงู ุชุญููู ุฐูู
  ูุจูู ุนูู ุจูุงูุงุช ุณูููุฉ ูุนููุฉ ูุง ุนูู ุงูุชุฑุงุถุงุช ูุธุฑูุฉ.
โข ุงููุฑุงุฑ ุตุงูุญ ูููุฑุงุฌุนุฉ ุฎูุงู 3โ6 ุฃุดูุฑ ุญุณุจ ุชุทูุฑ ุงูุณูู.
"""

    return summary.strip()

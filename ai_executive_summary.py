# ai_executive_summary.py
# =========================================
# Executive Decision Engine โ Warda Intelligence
# =========================================

from smart_opportunities import SmartOpportunityFinder


# =========================================
# ๐ง ุงูููุงู ุงูุชูููุฐู ุงูุญุงูู ูููุฑุงุฑ
# =========================================
class FinalDecision:
    def __init__(
        self,
        stance: str,              # MOVE / WAIT / AVOID (ูุฑุงุฑ ุญุฑูุฉ ุนุงู)
        confidence: float,        # 0.00 โ 1.00
        horizon: str,             # "3โ5 ุณููุงุช"
        rationale: list,
        risks: list,
        change_triggers: list,
        execution_guidance: list
    ):
        self.stance = stance
        self.confidence = confidence
        self.horizon = horizon
        self.rationale = rationale
        self.risks = risks
        self.change_triggers = change_triggers
        self.execution_guidance = execution_guidance

    def to_text(self) -> str:
        """
        ุตูุงุบุฉ ุชูููุฐูุฉ ูุงุฎุฑุฉ ุชุตูุญ ููู:
        ุดุฑุงุก / ุจูุน / ุฅูุฌุงุฑ
        """
        lines = []

        lines.append("ุงููุฑุงุฑ ุงูุงุณุชุดุงุฑู ุงูููุงุฆู: ููููู ุงูุตุญูุญ ุงูุขู")
        lines.append("")

        lines.append(f"โข ุงููููู ุงูุงุณุชุซูุงุฑู: {self.stance}")
        lines.append(f"โข ุฏุฑุฌุฉ ุงูุซูุฉ ูู ูุฐุง ุงููููู: {int(self.confidence * 100)}%")
        lines.append(f"โข ุงูุฃูู ุงูุฒููู ุงููุฑุฌุนู: {self.horizon}")
        lines.append("")

        lines.append("ููุงุฐุง ูุฐุง ูู ุงููููู ุงูุฃูุณุจ ุงูุขูุ")
        for r in self.rationale:
            lines.append(f"- {r}")

        lines.append("")
        lines.append("ุงููุฎุงุทุฑ ุงูุชู ูุฌุจ ุฃู ุชุจูู ุชุญุช ุงููุฑุงูุจุฉ:")
        for r in self.risks:
            lines.append(f"- {r}")

        lines.append("")
        lines.append("ูุชู ูุนูุฏ ุชูููู ูุฐุง ุงูููููุ")
        for t in self.change_triggers:
            lines.append(f"- {t}")

        lines.append("")
        lines.append("ููู ุชุชุตุฑู ุนููููุง ุจุนุฏ ุฅุบูุงู ูุฐุง ุงูุชูุฑูุฑ:")
        for g in self.execution_guidance:
            lines.append(f"- {g}")

        return "\n".join(lines)


# =========================================
# ๐ง ูููุฏ ุงููุฑุงุฑ ุงูุงุณุชุดุงุฑู ุงูููุงุฆู
# =========================================
def generate_executive_summary(user_info, market_data, real_data):
    if real_data is None or real_data.empty:
        return (
            "โ ูุง ูููู ุฅุตุฏุงุฑ ูููู ุงุณุชุดุงุฑู ููุซูู ูุบูุงุจ ุจูุงูุงุช ุณูููุฉ ูุนููุฉ.\n"
            "ููุตู ุจุงูุงูุชูุงุก ุจุงููุฑุงูุจุฉ ุฅูู ุญูู ุชููุฑ ุจูุงูุงุช ุญููููุฉ ูุงุจูุฉ ููุชุญููู."
        )

    city = user_info.get("city", "ุงููุฏููุฉ")

    finder = SmartOpportunityFinder()
    undervalued = finder.find_undervalued_properties(real_data, city)

    liquidity = market_data.get("ูุคุดุฑ_ุงูุณูููุฉ", 0)
    growth = market_data.get("ูุนุฏู_ุงูููู_ุงูุดูุฑู", 0)

    # =========================
    # ๐ฆ ููุทู ุงุชุฎุงุฐ ูููู ุงูุญุฑูุฉ
    # =========================

    # ๐ข ูููู ุงูุชุญุฑู ุงููุฏุฑูุณ
    if liquidity >= 60 and growth >= 1.2 and len(undervalued) >= 3:
        decision = FinalDecision(
            stance="ุงูุชุญุฑู ุงููุฏุฑูุณ",
            confidence=0.86,
            horizon="5โ7 ุณููุงุช",
            rationale=[
                "ุงูุทูุจ ุงูุญุงูู ูุนูุณ ุงุณุชุฎุฏุงููุง ูุนูููุง ูุง ุงูุฏูุงุนูุง ูุคูุชูุง",
                "ูุฌูุฏ ูุฌูุงุช ุณุนุฑูุฉ ููุงุฑูุฉ ุจุงููููุฉ ุงูุชุดุบูููุฉ",
                "ุงูุณูููุฉ ุงูุนุงูุฉ ุชุณูุญ ุจุงูุญุฑูุฉ ุฏูู ุถุบุท ุฎุฑูุฌ"
            ],
            risks=[
                "ุฒูุงุฏุฉ ุบูุฑ ูุชููุนุฉ ูู ุงููุนุฑูุถ",
                "ุชุญูู ุชูุธููู ูุฏ ูุคุซุฑ ุนูู ุจุนุถ ุงููุฆุงุช"
            ],
            change_triggers=[
                "ุชุฑุงุฌุน ูุคุดุฑ ุงูุณูููุฉ ุฏูู ูุณุชูู 50",
                "ุงุชุณุงุน ุงููุฌูุฉ ุจูู ุงูุฃุณุนุงุฑ ุงููุนุฑูุถุฉ ูุงููููุฐุฉ"
            ],
            execution_guidance=[
                "ุงูุงูุชุฒุงู ุจุญุฑูุฉ ููุถุจุทุฉ ูุง ุชูุณุนูุฉ",
                "ุฑุจุท ุฃู ุฎุทูุฉ ุจูุฏู ูุงุถุญ (ุชุดุบูู / ุชุฎุงุฑุฌ / ุงุณุชูุฑุงุฑ)",
                "ูุฑุงุฌุนุฉ ุงููููู ูู 6 ุฃุดูุฑ ุจูุงุกู ุนูู ุจูุงูุงุช ุงูุณูู"
            ]
        )

    # ๐ด ูููู ุชุฌูุจ ุงูุชูููุฐ
    elif liquidity < 45 or growth < 0.8:
        decision = FinalDecision(
            stance="ุชุฌูุจ ุงูุชูููุฐ ูู ุงููุถุน ุงูุญุงูู",
            confidence=0.79,
            horizon="3โ5 ุณููุงุช",
            rationale=[
                "ุถุนู ุงูุณูููุฉ ูููู ูุฑููุฉ ุงูุญุฑูุฉ",
                "ุงุชุฌุงู ุงูููู ุบูุฑ ูุณุชูุฑ ุจูุง ูููู"
            ],
            risks=[
                "ุชุฌููุฏ ุงููุฑุงุฑ ููุชุฑุฉ ุฃุทูู ูู ุงููุชููุน",
                "ุตุนูุจุฉ ุชุนุฏูู ุงููุณุงุฑ ูุงุญููุง"
            ],
            change_triggers=[
                "ุชุญุณู ุงูุณูููุฉ ููู ูุณุชูู 60",
                "ุนูุฏุฉ ุงูููู ุงูุดูุฑู ููุณุชููุงุช ุตุญูุฉ"
            ],
            execution_guidance=[
                "ุงูุงูุชูุงุก ุจุงููุฑุงูุจุฉ ุงูุฐููุฉ ุฏูู ุงูุชุฒุงู",
                "ุชุญุฏูุซ ุงููุฑุงุกุฉ ุนูุฏ ุฃู ุชุบูุฑ ุฌููุฑู ูู ุงููุคุดุฑุงุช",
                "ุนุฏู ุงุชุฎุงุฐ ูุฑุงุฑุงุช ุจุฏุงูุน ุงูููุงุฑูุฉ ุฃู ุงูุถุบุท"
            ]
        )

    # ๐ก ูููู ุงูุชุฑูุจ ุงูุฐูู
    else:
        decision = FinalDecision(
            stance="ุงูุชุฑูุจ ุงูุฐูู",
            confidence=0.82,
            horizon="2โ4 ุณููุงุช",
            rationale=[
                "ุงูุณูู ูู ูุฑุญูุฉ ุงูุชูุงุฆูุฉ",
                "ุงููุฑุต ูู ุชูุชูู ุฅุดุงุฑุงุชูุง ุจุนุฏ"
            ],
            risks=[
                "ุงูุฏุฎูู ุงููุจูุฑ",
                "ุชูููุช ูุฑุต ุฃูุถุญ ูุงุญููุง"
            ],
            change_triggers=[
                "ุธููุฑ ุฎุตููุงุช ุญููููุฉ ูุฏููุนุฉ ุจุณููู ุงูุณูู",
                "ุชุญุณู ูุคุดุฑุงุช ุงูุทูุจ ุงููุนูู"
            ],
            execution_guidance=[
                "ุงูุงุณุชุนุฏุงุฏ ุฏูู ุงูุชุฒุงู",
                "ุชุฌููุฒ ุงููุฑุงุฑ ูุงูููุง ูููุณููุง",
                "ุฅุนุงุฏุฉ ุงูุชูููู ูู 3 ุฃุดูุฑ"
            ]
        )

    return decision.to_text()

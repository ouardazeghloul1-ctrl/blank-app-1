# user_profiler.py - Ù…Ø­Ù„Ù„ Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒÙŠ
import pandas as pd
import numpy as np
from datetime import datetime

class UserProfiler:
    def __init__(self):
        self.user_needs = {
            "Ù…Ø³ØªØ«Ù…Ø±": {
                "primary_need": "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠØ©",
                "key_questions": [
                    "Ù…Ø§ Ù‡ÙŠ Ø£ÙØ¶Ù„ Ø§Ù„ÙØ±Øµ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹ØŸ",
                    "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØŸ",
                    "ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŸ",
                    "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ù…ÙˆØ§Ù‹ØŸ"
                ],
                "metrics": ["Ø§Ù„Ø¹Ø§Ø¦Ø¯_Ø§Ù„Ù…ØªÙˆÙ‚Ø¹", "Ù…Ø³ØªÙˆÙ‰_Ø§Ù„Ø®Ø·ÙˆØ±Ø©", "Ù†Ù…Ùˆ_Ø§Ù„Ø³Ø¹Ø±", "Ø§Ù„Ø³ÙŠÙˆÙ„Ø©"]
            },
            "Ù…Ø§Ù„Ùƒ Ø¹Ù‚Ø§Ø±": {
                "primary_need": "ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‚ØµÙ‰ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±", 
                "key_questions": [
                    "ÙƒÙ… ØªØ¨Ù„Øº Ù‚ÙŠÙ…Ø© Ø¹Ù‚Ø§Ø±ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ",
                    "Ù…Ø§ Ù‡Ùˆ Ø£ÙØ¶Ù„ ÙˆÙ‚Øª Ù„Ù„Ø¨ÙŠØ¹ØŸ",
                    "ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø²ÙŠØ§Ø¯Ø© Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±ØŸ",
                    "Ù…Ø§ Ù‡ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙŠØŸ"
                ],
                "metrics": ["Ø³Ø¹Ø±_Ø§Ù„Ù…ØªØ±", "Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©", "Ø§Ù„Ø¹Ø±Ø¶_ÙˆØ§Ù„Ø·Ù„Ø¨", "Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª"]
            },
            "ÙØ±Ø¯": {
                "primary_need": "Ø¥ÙŠØ¬Ø§Ø¯ Ø³ÙƒÙ† Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù…Ø¹Ù‚ÙˆÙ„Ø©",
                "key_questions": [
                    "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØªÙŠØŸ",
                    "Ù…Ø§ Ù‡ÙŠ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø©ØŸ",
                    "Ø£ÙŠÙ‡Ù…Ø§ Ø£ÙØ¶Ù„: Ø§Ù„Ø´Ø±Ø§Ø¡ Ø£Ù… Ø§Ù„ØªØ£Ø¬ÙŠØ±ØŸ",
                    "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø£Ø³Ø±Ø©ØŸ"
                ],
                "metrics": ["Ø§Ù„Ø³Ø¹Ø±", "Ø§Ù„Ù…Ø³Ø§Ø­Ø©", "Ø§Ù„Ù…ÙˆÙ‚Ø¹", "Ø§Ù„Ù…Ø±Ø§ÙÙ‚"]
            },
            "ÙˆØ³ÙŠØ· Ø¹Ù‚Ø§Ø±ÙŠ": {
                "primary_need": "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµÙÙ‚Ø§Øª ÙˆØªØ­Ù‚ÙŠÙ‚ Ø¹Ù…ÙˆÙ„Ø§Øª Ø£Ø¹Ù„Ù‰",
                "key_questions": [
                    "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ØŸ",
                    "ÙƒÙŠÙ Ø£Ø¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¬Ø¯Ø¯ØŸ",
                    "Ù…Ø§ Ù‡ÙŠ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ",
                    "ÙƒÙŠÙ Ø£ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±ØŸ"
                ],
                "metrics": ["Ø­Ø¬Ù…_Ø§Ù„ØªØ¯Ø§ÙˆÙ„", "Ø§Ù„Ø·Ù„Ø¨Ø§Øª", "Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©", "Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª"]
            },
            "Ø´Ø±ÙƒØ© ØªØ·ÙˆÙŠØ±": {
                "primary_need": "ØªØ®Ø·ÙŠØ· Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø±Ø¨Ø­Ø© ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙØ±Øµ",
                "key_questions": [
                    "Ø£ÙŠÙ† ØªÙˆØ¬Ø¯ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„ØªØ·ÙˆÙŠØ±ØŸ",
                    "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ",
                    "ÙƒÙŠÙ Ø£ØªÙÙˆÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ†ØŸ",
                    "Ù…Ø§ Ù‡ÙŠ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ØŸ"
                ],
                "metrics": ["Ø§Ù„Ø·Ù„Ø¨_Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ", "Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ", "Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯", "Ø§Ù„Ù…Ø®Ø§Ø·Ø±"]
            },
            "Ø¨Ø§Ø­Ø« Ø¹Ù† ÙØ±ØµØ©": {
                "primary_need": "Ø§ÙƒØªØ´Ø§Ù ÙØ±Øµ Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ© ÙˆØºÙŠØ± ØªÙ‚Ù„ÙŠØ¯ÙŠØ©",
                "key_questions": [
                    "Ø£ÙŠÙ† ØªÙˆØ¬Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©ØŸ",
                    "ÙƒÙŠÙ Ø£ÙƒØªØ´Ù Ø§Ù„ÙØ±Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŸ",
                    "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ØºÙŠØ± Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©ØŸ",
                    "ÙƒÙŠÙ Ø£Ø³ØªÙÙŠØ¯ Ù…Ù† ØªÙ‚Ù„Ø¨Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ØŸ"
                ],
                "metrics": ["Ø§Ù„ÙØ±Øµ_Ø§Ù„Ø®Ø§ØµØ©", "Ø§Ù„ØªÙˆÙ‚ÙŠØª", "Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±", "Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©"]
            }
        }
    
    def analyze_user_profile(self, user_info, market_data, real_data):
        """ØªØ­Ù„ÙŠÙ„ Ù…ØªØ¹Ù…Ù‚ Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        user_type = user_info.get('user_type', 'Ù…Ø³ØªØ«Ù…Ø±')
        profile = self.user_needs.get(user_type, self.user_needs['Ù…Ø³ØªØ«Ù…Ø±'])
        
        analysis = {
            "user_type": user_type,
            "primary_need": profile["primary_need"],
            "key_questions": profile["key_questions"],
            "personalized_analysis": self._generate_personalized_analysis(user_info, market_data, real_data, profile),
            "recommendations": self._generate_recommendations(user_info, market_data, real_data, profile)
        }
        
        return analysis
    
    def _generate_personalized_analysis(self, user_info, market_data, real_data, profile):
        """ØªØ­Ù„ÙŠÙ„ Ù…Ø®ØµØµ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø³ÙˆÙ‚"""
        user_city = user_info.get('city', 'Ø§Ù„Ø±ÙŠØ§Ø¶')
        property_type = user_info.get('property_type', 'Ø´Ù‚Ø©')
        user_budget = user_info.get('area', 120) * 5000  # ØªÙ‚Ø¯ÙŠØ± Ù…Ø¨Ø¯Ø¦ÙŠ
        
        analysis = f"""
        ðŸ” **Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ:**
        
        **Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:** {user_city}
        **Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±:** {property_type} 
        **Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©:** {user_budget:,.0f} Ø±ÙŠØ§Ù„
        
        """
        
        # Ø¥Ø¶Ø§ÙØ© ØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if profile["primary_need"] == "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠØ©":
            analysis += self._investor_analysis(real_data, user_budget)
        elif profile["primary_need"] == "ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‚ØµÙ‰ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±":
            analysis += self._owner_analysis(real_data, user_info)
        elif profile["primary_need"] == "Ø¥ÙŠØ¬Ø§Ø¯ Ø³ÙƒÙ† Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù…Ø¹Ù‚ÙˆÙ„Ø©":
            analysis += self._individual_analysis(real_data, user_budget)
            
        return analysis
    
    def _investor_analysis(self, real_data, budget):
        """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±"""
        if real_data.empty:
            return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„"
        
        high_return = real_data[real_data['Ø§Ù„Ø¹Ø§Ø¦Ø¯_Ø§Ù„Ù…ØªÙˆÙ‚Ø¹'] > real_data['Ø§Ù„Ø¹Ø§Ø¦Ø¯_Ø§Ù„Ù…ØªÙˆÙ‚Ø¹'].mean()]
        affordable_high_return = high_return[high_return['Ø§Ù„Ø³Ø¹Ø±'] <= budget * 1.2]
        
        analysis = f"""
        ðŸ“ˆ **ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±:**
        
        â€¢ **Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Øµ Ø°Ø§Øª Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ù…Ø±ØªÙØ¹Ø©:** {len(affordable_high_return)} Ø¹Ù‚Ø§Ø±
        â€¢ **Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ø¦Ø¯ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚:** {real_data['Ø§Ù„Ø¹Ø§Ø¦Ø¯_Ø§Ù„Ù…ØªÙˆÙ‚Ø¹'].mean():.1f}%
        â€¢ **Ø£Ø¹Ù„Ù‰ Ø¹Ø§Ø¦Ø¯ Ù…ØªØ§Ø­:** {real_data['Ø§Ù„Ø¹Ø§Ø¦Ø¯_Ø§Ù„Ù…ØªÙˆÙ‚Ø¹'].max():.1f}%
        
        ðŸ’¼ **Ø§Ù„ÙØ±Øµ Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¶Ù…Ù† Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ:**
        """
        
        if not affordable_high_return.empty:
            for _, prop in affordable_high_return.head(3).iterrows():
                analysis += f"\n   â€¢ {prop['Ø§Ù„Ø¹Ù‚Ø§Ø±']} - Ø¹Ø§Ø¦Ø¯ {prop['Ø§Ù„Ø¹Ø§Ø¦Ø¯_Ø§Ù„Ù…ØªÙˆÙ‚Ø¹']}%"
        else:
            analysis += "\n   â€¢ Ù†ÙˆØµÙŠ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±"
            
        return analysis
    
    def _generate_recommendations(self, user_info, market_data, real_data, profile):
        """ØªÙˆÙ„ÙŠØ¯ ØªÙˆØµÙŠØ§Øª Ù…Ø®ØµØµØ©"""
        recommendations = []
        
        if profile["primary_need"] == "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠØ©":
            recommendations = [
                "Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†Ø§Ù…ÙŠØ© Ø°Ø§Øª Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©",
                "ØªÙ†ÙˆÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ© ÙˆØ§Ù„ØªØ¬Ø§Ø±ÙŠØ©",
                "Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø£Ø³Ø¹Ø§Ø± Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚",
                "Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø´Ù‡Ø±ÙŠØ§Ù‹ Ù„ØªØ­Ù‚ÙŠÙ‚ Ø£Ø±Ø¨Ø§Ø­ Ø³Ø±ÙŠØ¹Ø©"
            ]
        elif profile["primary_need"] == "ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‚ØµÙ‰ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¹Ù‚Ø§Ø±":
            recommendations = [
                "ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ÙˆØ§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ø¹Ù‚Ø§Ø±",
                "Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 3-6 Ø£Ø´Ù‡Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³ÙˆÙ‚ ÙÙŠ Ø§ØªØ¬Ø§Ù‡ ØµØ§Ø¹Ø¯",
                "Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØµØ© Ù„ØªÙˆØ³ÙŠØ¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ†",
                "Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù„Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
            ]
            
        return recommendations
